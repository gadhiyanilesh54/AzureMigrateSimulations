<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Migrate Simulations â€“ Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- vis-network for topology -->
    <script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --azure-blue: #0078d4;
            --azure-dark: #003d6b;
            --azure-light: #50e6ff;
            --success-green: #10b981;
            --warn-yellow: #f59e0b;
            --danger-red: #ef4444;
        }
        body { background: #0d1117; color: #e6edf3; font-family: 'Segoe UI', system-ui, sans-serif; }
        .navbar { background: linear-gradient(135deg, #0078d4 0%, #003d6b 100%) !important; }
        .navbar-brand { font-weight: 700; letter-spacing: 0.5px; }
        .nav-pills .nav-link { color: #8b949e; border-radius: 8px; margin: 0 2px; transition: all 0.2s; }
        .nav-pills .nav-link.active { background: var(--azure-blue); color: #fff; }
        .nav-pills .nav-link:hover:not(.active) { background: rgba(255,255,255,0.08); color: #e6edf3; }

        .stat-card {
            background: #161b22; border: 1px solid #30363d; border-radius: 12px;
            padding: 20px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,120,212,0.15); }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--azure-light); }
        .stat-card .stat-label { font-size: 0.85rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .stat-icon { font-size: 2.5rem; color: var(--azure-blue); opacity: 0.7; }

        .card-dark {
            background: #161b22; border: 1px solid #30363d; border-radius: 12px;
        }
        .card-dark .card-header {
            background: rgba(0,120,212,0.1); border-bottom: 1px solid #30363d;
            font-weight: 600; padding: 12px 20px;
        }

        #topology-container { height: 650px; background: #0d1117; border-radius: 8px; border: 1px solid #30363d; }

        .table-dark-custom { background: transparent; }
        .table-dark-custom th { background: rgba(0,120,212,0.15); color: var(--azure-light); border-color: #30363d; position: sticky; top: 0; z-index: 1;}
        .table-dark-custom td { border-color: #21262d; vertical-align: middle; }
        .table-dark-custom tbody tr:hover { background: rgba(0,120,212,0.08); }

        .badge-ready { background: var(--success-green); }
        .badge-conditional { background: var(--warn-yellow); color: #000; }
        .badge-not-ready { background: var(--danger-red); }

        .search-box { background: #0d1117; border: 1px solid #30363d; color: #e6edf3; border-radius: 8px; }
        .search-box:focus { border-color: var(--azure-blue); box-shadow: 0 0 0 3px rgba(0,120,212,0.2); color: #e6edf3; background: #0d1117; }

        .sim-control { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 24px; }
        .form-select, .form-control { background: #0d1117; border-color: #30363d; color: #e6edf3; }
        .form-select:focus, .form-control:focus { border-color: var(--azure-blue); box-shadow: 0 0 0 3px rgba(0,120,212,0.2); background: #0d1117; color: #e6edf3; }
        .btn-azure { background: var(--azure-blue); color: white; border: none; border-radius: 8px; padding: 10px 24px; font-weight: 600; }
        .btn-azure:hover { background: #106ebe; color: white; }

        .topology-legend { display: flex; flex-wrap: wrap; gap: 16px; padding: 12px 20px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: #8b949e; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }

        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(13,17,23,0.8); display: flex; align-items: center;
            justify-content: center; z-index: 100; border-radius: 12px;
        }

        .tab-pane { padding-top: 24px; }
        .assessment-scroll { max-height: 600px; overflow-y: auto; }

        .wave-card { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 16px; margin-bottom: 12px; transition: border-color 0.2s; }
        .wave-card .wave-num { font-size: 1.4rem; font-weight: 700; color: var(--azure-blue); }
        .wave-card.drag-over { border-color: var(--azure-blue); background: #1a2233; box-shadow: 0 0 12px rgba(0,120,212,0.25); }
        .wave-dropzone { min-height: 36px; padding: 4px 0; }
        .wave-item { display: inline-block; cursor: grab; user-select: none; transition: opacity 0.15s, transform 0.15s; }
        .wave-item:active { cursor: grabbing; }
        .wave-item.dragging { opacity: 0.35; transform: scale(0.92); }
        .wave-card .wave-hint { font-size: 0.7rem; color: #484f58; margin-top: 6px; }
        .cost-highlight { font-size: 1.8rem; font-weight: 700; }
        .cost-savings { color: var(--success-green); }
        .cost-increase { color: var(--danger-red); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }

        /* VM What-If Modal */
        .vm-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1050; display:none; align-items:flex-start; justify-content:center; padding-top:40px; overflow-y:auto; }
        .vm-modal-backdrop.show { display:flex; }
        .vm-modal { background:#161b22; border:1px solid #30363d; border-radius:16px; width:95%; max-width:1100px; margin-bottom:40px; animation:fadeIn 0.25s ease-out; }
        .vm-modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 24px; border-bottom:1px solid #30363d; background:rgba(0,120,212,0.08); border-radius:16px 16px 0 0; }
        .vm-modal-header h5 { margin:0; font-weight:700; }
        .vm-modal-body { padding:24px; }
        .vm-modal-close { background:none; border:none; color:#8b949e; font-size:1.5rem; cursor:pointer; padding:4px 8px; }
        .vm-modal-close:hover { color:#e6edf3; }
        .vm-detail-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; }
        .vm-detail-item { background:#0d1117; border:1px solid #21262d; border-radius:8px; padding:10px 14px; }
        .vm-detail-item .label { font-size:0.75rem; color:#8b949e; text-transform:uppercase; letter-spacing:0.5px; }
        .vm-detail-item .value { font-size:1rem; font-weight:600; color:#e6edf3; margin-top:2px; }
        .sku-option { background:#0d1117; border:1px solid #21262d; border-radius:10px; padding:12px 16px; cursor:pointer; transition:all 0.2s; }
        .sku-option:hover { border-color:var(--azure-blue); background:rgba(0,120,212,0.05); }
        .sku-option.selected { border-color:var(--azure-blue); background:rgba(0,120,212,0.1); box-shadow:0 0 0 2px rgba(0,120,212,0.3); }
        .sku-option.current-rec { border-color:var(--success-green); }
        .sku-option.doesnt-fit { opacity:0.45; }
        .sku-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:10px; max-height:340px; overflow-y:auto; padding:4px; }
        .whatif-cost-display { font-size:2.2rem; font-weight:800; color:var(--azure-light); }
        .whatif-savings { font-size:1.1rem; }
        .whatif-controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
        .whatif-controls select { min-width:180px; }
        .compare-bar { height:8px; border-radius:4px; transition:width 0.4s ease; }
        @media(max-width:768px) { .vm-detail-grid { grid-template-columns: 1fr 1fr; } .sku-grid { grid-template-columns: 1fr; } }

        /* Connection Screen */
        .connect-overlay {
            position:fixed; inset:0; background:#0d1117; z-index:2000;
            display:flex; align-items:center; justify-content:center;
            transition:opacity 0.5s ease;
        }
        .connect-overlay.hidden { opacity:0; pointer-events:none; }
        .connect-card {
            background:#161b22; border:1px solid #30363d; border-radius:16px;
            width:580px; max-width:95vw; padding:40px;
        }
        .connect-card h2 { font-weight:700; margin-bottom:4px; }
        .connect-card .subtitle { color:#8b949e; margin-bottom:32px; font-size:0.95rem; }
        .connect-card .form-label { font-weight:600; font-size:0.85rem; color:#8b949e; }
        .connect-divider {
            display:flex; align-items:center; gap:16px; margin:24px 0;
            color:#484f58; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px;
        }
        .connect-divider::before, .connect-divider::after {
            content:''; flex:1; height:1px; background:#30363d;
        }
        .progress-area { display:none; margin-top:24px; }
        .progress-area.active { display:block; }
        .progress-bar-track { height:6px; background:#21262d; border-radius:3px; overflow:hidden; }
        .progress-bar-fill {
            height:100%; border-radius:3px; transition:width 0.5s ease; width:0%;
            background:linear-gradient(90deg, var(--azure-blue), var(--azure-light));
        }
        .progress-msg { font-size:0.85rem; color:#8b949e; margin-top:8px; }
        .connect-error { color:var(--danger-red); font-size:0.9rem; margin-top:12px; display:none; }
    </style>
</head>
<body>
    <!-- ==================== CONNECTION OVERLAY ==================== -->
    <div class="connect-overlay" id="connectOverlay">
        <div class="connect-card">
            <div class="text-center mb-2">
                <i class="bi bi-diagram-3-fill" style="font-size:3rem; color:var(--azure-blue);"></i>
            </div>
            <h2 class="text-center">Azure Migrate Simulations</h2>
            <p class="subtitle text-center">
                Connect to your VMware vCenter to discover and simulate Azure migration
            </p>

            <form id="connectForm" onsubmit="return startDiscovery(event)">
                <div class="mb-3">
                    <label class="form-label" for="vcUrl">vCenter Server URL</label>
                    <input type="text" class="form-control" id="vcUrl"
                           placeholder="vcenter.example.com" required>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label" for="vcUser">Username</label>
                        <input type="text" class="form-control" id="vcUser"
                               placeholder="administrator@vsphere.local" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="vcPass">Password</label>
                        <input type="password" class="form-control" id="vcPass" required>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-4">
                        <label class="form-label" for="vcPort">Port</label>
                        <input type="number" class="form-control" id="vcPort" value="443">
                    </div>
                    <div class="col-4 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vcSsl" checked>
                            <label class="form-check-label" for="vcSsl">Skip SSL verify</label>
                        </div>
                    </div>
                    <div class="col-4 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vcPerf" checked
                                   onchange="document.getElementById('perfDurationRow').style.display=this.checked?'block':'none'">
                            <label class="form-check-label" for="vcPerf">Collect perf data</label>
                        </div>
                    </div>
                </div>
                <div class="mb-3" id="perfDurationRow">
                    <label class="form-label" for="vcPerfDuration">Performance Data Capture Duration</label>
                    <select class="form-select" id="vcPerfDuration">
                        <option value="1">1 Day</option>
                        <option value="7" selected>7 Days (Recommended)</option>
                        <option value="30">30 Days</option>
                    </select>
                    <div class="form-text" style="color:#8b949e">Longer duration gives more accurate right-sizing recommendations</div>
                </div>
                <button type="submit" class="btn btn-azure w-100" id="btnConnect">
                    <i class="bi bi-plug me-2"></i>Connect &amp; Discover
                </button>
            </form>

            <div class="connect-divider" id="connectDivider">or</div>

            <div class="text-center" id="uploadArea">
                <label class="btn btn-outline-secondary w-100" for="fileUpload" style="cursor:pointer;">
                    <i class="bi bi-file-earmark-arrow-up me-2"></i>Load from Report File (.json)
                </label>
                <input type="file" id="fileUpload" accept=".json" style="display:none;"
                       onchange="uploadReport(this)">
            </div>

            <div class="progress-area" id="progressArea">
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressFill"></div>
                </div>
                <div class="progress-msg" id="progressMsg">Initializingâ€¦</div>
            </div>

            <div class="connect-error" id="connectError"></div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark px-4 py-2 shadow">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-diagram-3-fill me-2"></i>Azure Migrate Simulations
            </a>
            <span class="text-white-50 small d-none" id="navHost">
                <i class="bi bi-hdd-network me-1"></i> <span id="navHostName"></span>
            </span>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white-50 small d-none d-md-inline">
                    <i class="bi bi-cloud-fill me-1"></i> Azure Migration Dashboard
                </span>
                <button class="btn btn-outline-light btn-sm d-none" id="btnDisconnect"
                        onclick="disconnect()">
                    <i class="bi bi-box-arrow-right me-1"></i>New Connection
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4 py-3">
        <!-- TAB NAV -->
        <ul class="nav nav-pills mb-3" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="tab-dashboard" data-bs-toggle="pill"
                        data-bs-target="#pane-dashboard" type="button">
                    <i class="bi bi-speedometer2 me-1"></i> Dashboard
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-workloads" data-bs-toggle="pill"
                        data-bs-target="#pane-workloads" type="button">
                    <i class="bi bi-layers me-1"></i> Discovery &amp; Assessment
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-businesscase" data-bs-toggle="pill"
                        data-bs-target="#pane-businesscase" type="button">
                    <i class="bi bi-briefcase me-1"></i> Business Case
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-enrichment" data-bs-toggle="pill"
                        data-bs-target="#pane-enrichment" type="button">
                    <i class="bi bi-graph-up-arrow me-1"></i> Enrichment
                </button>
            </li>
        </ul>

        <!-- TAB CONTENT -->
        <div class="tab-content" id="mainTabContent">

            <!-- ==================== DASHBOARD ==================== -->
            <div class="tab-pane fade show active" id="pane-dashboard" role="tabpanel">
                <!-- Summary Cards -->
                <div class="row g-3 mb-4" id="summary-cards">
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-pc-display"></i></div>
                            <div class="stat-value" id="card-vms">â€”</div>
                            <div class="stat-label">Virtual Machines</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-hdd-rack"></i></div>
                            <div class="stat-value" id="card-hosts">â€”</div>
                            <div class="stat-label">ESXi Hosts</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-cpu"></i></div>
                            <div class="stat-value" id="card-vcpus">â€”</div>
                            <div class="stat-label">Total vCPUs</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-memory"></i></div>
                            <div class="stat-value" id="card-memory">â€”</div>
                            <div class="stat-label">Total Memory (GB)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-hdd"></i></div>
                            <div class="stat-value" id="card-disk">â€”</div>
                            <div class="stat-label">Total Disk (TB)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                            <div class="stat-value" id="card-cost">â€”</div>
                            <div class="stat-label">Est. Monthly Cost</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Migration Readiness</div>
                            <div class="card-body p-3">
                                <canvas id="chart-readiness" height="260"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-pie-chart me-2"></i>OS Distribution</div>
                            <div class="card-body p-3">
                                <canvas id="chart-os" height="260"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-pie-chart me-2"></i>Power State</div>
                            <div class="card-body p-3">
                                <canvas id="chart-power" height="260"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Azure VM Family Distribution</div>
                            <div class="card-body p-3">
                                <canvas id="chart-family" height="280"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Monthly Cost by VM Family</div>
                            <div class="card-body p-3">
                                <canvas id="chart-cost-family" height="280"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="card-dark">
                            <div class="card-header"><i class="bi bi-folder me-2"></i>VMs by Folder</div>
                            <div class="card-body p-3">
                                <canvas id="chart-folders" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== DISCOVERY & ASSESSMENT ==================== -->
            <div class="tab-pane fade" id="pane-workloads" role="tabpanel">
                <div class="row g-4">
                    <!-- Left: Credentials & Controls -->
                    <div class="col-lg-4">
                        <!-- Credential Form -->
                        <div class="sim-control mb-3">
                            <h5 class="mb-3"><i class="bi bi-key me-2"></i>Guest Credentials</h5>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="small text-muted mb-0"><i class="bi bi-ubuntu me-1"></i>Linux (SSH)</h6>
                                <button class="btn btn-sm" style="background:#21262d;color:#58a6ff;border:1px solid #30363d;font-size:0.75rem;padding:2px 8px;" onclick="addLinuxCred()">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                            <div id="wl-linux-creds-list">
                                <div class="wl-cred-entry mb-2" data-os="linux">
                                    <div class="row g-2 mb-1">
                                        <div class="col-6">
                                            <input type="text" class="form-control form-control-sm wl-linux-user" placeholder="Username (e.g. root)">
                                        </div>
                                        <div class="col-3">
                                            <input type="password" class="form-control form-control-sm wl-linux-pass" placeholder="Password">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" class="form-control form-control-sm wl-linux-port" value="22" placeholder="Port">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                                <h6 class="small text-muted mb-0"><i class="bi bi-windows me-1"></i>Windows (WinRM)</h6>
                                <button class="btn btn-sm" style="background:#21262d;color:#58a6ff;border:1px solid #30363d;font-size:0.75rem;padding:2px 8px;" onclick="addWindowsCred()">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                            <div id="wl-win-creds-list">
                                <div class="wl-cred-entry mb-2" data-os="windows">
                                    <div class="row g-2 mb-1">
                                        <div class="col-6">
                                            <input type="text" class="form-control form-control-sm wl-win-user" placeholder="Administrator">
                                        </div>
                                        <div class="col-3">
                                            <input type="password" class="form-control form-control-sm wl-win-pass" placeholder="Password">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" class="form-control form-control-sm wl-win-port" value="5985" placeholder="Port">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-muted small mb-3 mt-1"><i class="bi bi-info-circle me-1"></i>Add multiple credentials â€” discovery will try each until one succeeds.</div>

                            <!-- Database Credentials (for deep DB probing) -->
                            <hr class="border-secondary my-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="small text-muted mb-0"><i class="bi bi-database me-1"></i>Database Credentials <span class="badge bg-info bg-opacity-25 text-info ms-1" style="font-size:0.65rem;">Optional</span></h6>
                                <button class="btn btn-sm" style="background:#21262d;color:#58a6ff;border:1px solid #30363d;font-size:0.75rem;padding:2px 8px;" onclick="addDbCred()">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                            <div id="wl-db-creds-list">
                                <div class="wl-cred-entry mb-2" data-os="db">
                                    <div class="row g-2 mb-1">
                                        <div class="col-3">
                                            <select class="form-select form-select-sm wl-db-engine">
                                                <option value="auto">Auto-detect</option>
                                                <option value="mssql">SQL Server</option>
                                                <option value="mysql">MySQL</option>
                                                <option value="postgresql">PostgreSQL</option>
                                                <option value="mongodb">MongoDB</option>
                                                <option value="redis">Redis</option>
                                                <option value="oracle">Oracle</option>
                                                <option value="mariadb">MariaDB</option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" class="form-control form-control-sm wl-db-user" placeholder="Username (e.g. sa)">
                                        </div>
                                        <div class="col-3">
                                            <input type="password" class="form-control form-control-sm wl-db-pass" placeholder="Password">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" class="form-control form-control-sm wl-db-port" placeholder="Port (auto)" title="Leave blank for default port">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-muted small mb-3 mt-1"><i class="bi bi-info-circle me-1"></i>Provide DB credentials to deep-discover databases (schemas, tables, sizes, users). Connects directly to DB engines found on each VM.</div>

                            <label class="form-label small">VM Selection</label>
                            <select class="form-select form-select-sm mb-3" id="wl-vm-selection">
                                <option value="powered_on">Powered On VMs</option>
                                <option value="all">All VMs</option>
                                <option value="linux">Linux Only</option>
                                <option value="windows">Windows Only</option>
                            </select>

                            <label class="form-label small d-flex justify-content-between">
                                <span>IP Mappings <span class="text-muted">(optional)</span></span>
                                <a href="#" class="small" onclick="event.preventDefault();document.getElementById('wl-ip-map').placeholder='WindowsVM175=10.126.86.50\nVM-SUSE12SP2=10.126.86.51'">example</a>
                            </label>
                            <textarea class="form-control form-control-sm mb-2" id="wl-ip-map" rows="3"
                                      placeholder="VMName=IP (one per line)&#10;e.g. WindowsVM175=10.0.0.50"
                                      style="font-family:monospace;font-size:0.8rem;"></textarea>
                            <div class="text-muted small mb-3">When VMs lack IPs from VMware Tools, provide manual mappings. Also tries DNS resolution of VM hostnames automatically.</div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="wl-try-dns">
                                <label class="form-check-label small" for="wl-try-dns">
                                    Try DNS resolution of VM hostnames <span class="text-muted">(can be slow)</span>
                                </label>
                            </div>

                            <label class="form-label small">Parallel Workers</label>
                            <input type="range" class="form-range" id="wl-workers" min="1" max="20" value="5">
                            <div class="text-muted small mb-3">Workers: <span id="wl-workers-val">5</span></div>

                            <button class="btn btn-azure w-100" onclick="startWorkloadDiscovery()" id="btnWorkloadDiscover">
                                <i class="bi bi-search me-1"></i> Discover Workloads
                            </button>

                            <div class="mt-2" id="wl-error-area" style="display:none;">
                                <div class="small text-danger" id="wl-error-msg"></div>
                                <div class="small text-muted mt-1" id="wl-skipped-vms" style="max-height:100px;overflow-y:auto;"></div>
                            </div>
                        </div>

                        <!-- Discovery Progress -->
                        <div class="sim-control mb-3" id="wl-progress-card" style="display:none;">
                            <h6 class="mb-2"><i class="bi bi-hourglass-split me-2"></i>Discovery Progress</h6>
                            <div class="progress-bar-track mb-2">
                                <div class="progress-bar-fill" id="wl-progress-fill" style="width:0%"></div>
                            </div>
                            <div class="small text-muted" id="wl-progress-msg">Initializingâ€¦</div>
                            <div class="small text-muted mt-1" id="wl-progress-detail"></div>
                        </div>

                        <!-- Discovery Summary -->
                        <div class="sim-control" id="vm-summary-card" style="display:none;">
                            <h6 class="mb-3"><i class="bi bi-bar-chart me-2"></i>Discovery Summary</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-pc-display me-1" style="color:#0078d4"></i>Total VMs</span>
                                <span class="fw-bold" id="disc-sum-vms">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-cpu me-1" style="color:#58a6ff"></i>Total vCPUs</span>
                                <span class="fw-bold" id="disc-sum-vcpus">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-memory me-1" style="color:#58a6ff"></i>Total RAM (GB)</span>
                                <span class="fw-bold" id="disc-sum-ram">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-hdd me-1" style="color:#58a6ff"></i>Total Disk (TB)</span>
                                <span class="fw-bold" id="disc-sum-disk">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-server me-1" style="color:#9966ff"></i>Hosts</span>
                                <span class="fw-bold" id="disc-sum-hosts">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-hdd-network me-1" style="color:#e879f9"></i>Networks</span>
                                <span class="fw-bold" id="disc-sum-networks">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted"><i class="bi bi-folder-symlink me-1" style="color:#fb923c"></i>File Shares</span>
                                <span class="fw-bold" id="disc-sum-fileshares">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Est. VM Cost/mo</span>
                                <span class="fw-bold cost-highlight" style="color:var(--azure-light)" id="disc-sum-vmcost">$0</span>
                            </div>
                            <!-- Workload section (appears after workload discovery) -->
                            <div id="wl-summary-section" style="display:none;">
                                <hr style="border-color:#30363d">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">VMs Scanned (workloads)</span>
                                    <span class="fw-bold" id="wl-sum-vms">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-database me-1" style="color:#f59e0b"></i>Databases</span>
                                    <span class="fw-bold" id="wl-sum-dbs">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-globe me-1" style="color:#10b981"></i>Web Apps</span>
                                    <span class="fw-bold" id="wl-sum-webapps">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-box me-1" style="color:#06b6d4"></i>Container / Orchestrator</span>
                                    <span class="fw-bold" id="wl-sum-containers">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Dependencies Detected</span>
                                    <span class="fw-bold" id="wl-sum-deps">0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Est. Workload Cost/mo</span>
                                    <span class="fw-bold cost-highlight" style="font-size:1.1rem; color:var(--azure-light)" id="wl-sum-cost">$0</span>
                                </div>
                            </div>
                            <!-- Performance Collector Status -->
                            <div id="perf-status-section" style="display:none;">
                                <hr style="border-color:#30363d">
                                <h6 class="mb-2"><i class="bi bi-activity me-1"></i>Performance Monitor</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">
                                        <span id="perf-status-dot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:6px;vertical-align:middle;"></span>
                                        Status
                                    </span>
                                    <span class="fw-bold" id="perf-status-label">Stopped</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-speedometer2 me-1" style="color:#58a6ff"></i>Avg CPU</span>
                                    <span class="fw-bold" id="perf-avg-cpu">â€”</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-memory me-1" style="color:#58a6ff"></i>Avg Memory</span>
                                    <span class="fw-bold" id="perf-avg-mem">â€”</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted"><i class="bi bi-hdd me-1" style="color:#58a6ff"></i>Total IOPS</span>
                                    <span class="fw-bold" id="perf-total-iops">â€”</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Samples</span>
                                    <span class="fw-bold" id="perf-sample-count">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Last Collected</span>
                                    <span class="fw-bold small" id="perf-last-time">â€”</span>
                                </div>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-sm btn-outline-success flex-fill" id="perf-btn-start" onclick="perfCollectorAction('start')" title="Start collector">
                                        <i class="bi bi-play-fill"></i> Start
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" id="perf-btn-stop" onclick="perfCollectorAction('stop')" style="display:none" title="Stop collector">
                                        <i class="bi bi-stop-fill"></i> Stop
                                    </button>
                                    <button class="btn btn-sm btn-outline-info flex-fill" id="perf-btn-collect" onclick="perfCollectorAction('collect')" title="Collect now">
                                        <i class="bi bi-lightning-fill"></i> Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Results Area -->
                    <div class="col-lg-8">
                        <!-- Unified sub-tab navigation -->
                        <ul class="nav nav-pills mb-3" id="discoverySubTabs">
                            <li class="nav-item">
                                <button class="nav-link active" id="subtab-inventory" data-bs-toggle="pill" data-bs-target="#pane-inventory" type="button">
                                    <i class="bi bi-list-ul me-1"></i>Inventory
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="subtab-topology" data-bs-toggle="pill" data-bs-target="#pane-topology" type="button">
                                    <i class="bi bi-diagram-3 me-1"></i>Topology
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="subtab-assessment" data-bs-toggle="pill" data-bs-target="#pane-assessment" type="button">
                                    <i class="bi bi-clipboard-check me-1"></i>Assessment
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="subtab-simulation" data-bs-toggle="pill" data-bs-target="#pane-simulation" type="button">
                                    <i class="bi bi-lightning-charge me-1"></i>Simulation
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">

                            <!-- ===== INVENTORY (unified) ===== -->
                            <div class="tab-pane fade show active" id="pane-inventory">
                                    <!-- Summary Filter Cards Row -->
                                    <div class="row g-2 mb-3" id="wl-filter-cards">
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="VM" role="button" onclick="toggleInventoryTypeFilter('VM')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#0078d4" id="wl-card-vms">0</div>
                                                <div class="stat-label">VMs</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="Database" role="button" onclick="toggleInventoryTypeFilter('Database')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#f59e0b" id="wl-card-dbs">0</div>
                                                <div class="stat-label">Databases</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="Web App" role="button" onclick="toggleInventoryTypeFilter('Web App')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#10b981" id="wl-card-webapps">0</div>
                                                <div class="stat-label">Web Apps</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="Container/Orchestrator" role="button" onclick="toggleInventoryTypeFilter('Container/Orchestrator')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#06b6d4" id="wl-card-containers">0</div>
                                                <div class="stat-label">Container / Orch</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="Network" role="button" onclick="toggleInventoryTypeFilter('Network')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#e879f9" id="wl-card-networks">0</div>
                                                <div class="stat-label">Networks</div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="stat-card text-center py-2 wl-filter-card" data-type="File Share" role="button" onclick="toggleInventoryTypeFilter('File Share')" style="cursor:pointer;border:2px solid transparent;transition:border-color .2s">
                                                <div style="font-size:1.5rem;font-weight:700;color:#fb923c" id="wl-card-fileshares">0</div>
                                                <div class="stat-label">File Shares</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Unified Inventory Table -->
                                    <div class="card-dark">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-table me-2"></i>Discovered Inventory</span>
                                            <input type="text" class="form-control form-control-sm search-box" style="width:250px"
                                                   placeholder="ðŸ” Search..." id="wl-inventory-search" oninput="filterWorkloadInventory()">
                                        </div>
                                        <div class="assessment-scroll">
                                            <table class="table table-sm table-dark-custom mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Parent VM</th>
                                                        <th>Type</th>
                                                        <th>Workload</th>
                                                        <th>Version</th>
                                                        <th>Port</th>
                                                        <th>Details</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="wl-inventory-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                            </div>

                            <!-- ===== TOPOLOGY ===== -->
                            <div class="tab-pane fade" id="pane-topology">
                                <div class="card-dark mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-3">
                                            <span><i class="bi bi-diagram-3 me-2"></i>Topology</span>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-light active" id="topo-view-infra" onclick="switchTopoView('infra')">Infrastructure</button>
                                                <button class="btn btn-outline-light" id="topo-view-deps" onclick="switchTopoView('deps')" style="display:none">Dependencies</button>
                                            </div>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-light me-2" onclick="currentTopoFit()">
                                                <i class="bi bi-arrows-fullscreen"></i> Fit
                                            </button>
                                            <button class="btn btn-sm btn-outline-light" id="topo-physics-btn" onclick="togglePhysics()">
                                                <i class="bi bi-gear"></i> Physics
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Infrastructure view -->
                                    <div id="topo-infra-view">
                                        <div class="topology-legend">
                                            <div class="legend-item"><span class="legend-dot" style="background:#0078d4"></span> vCenter</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#ffd700"></span> Datacenter</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#9966ff"></span> Host</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> VM (On)</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> VM (Off)</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> File Share</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#06b6d4"></span> Network</div>
                                        </div>
                                        <div id="topology-container"></div>
                                    </div>
                                    <!-- Dependencies view (shown after workload discovery) -->
                                    <div id="topo-deps-view" style="display:none;">
                                        <div class="topology-legend">
                                            <div class="legend-item"><span class="legend-dot" style="background:#0078d4"></span> VM</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> Database</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> Web App</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#06b6d4"></span> Container / Orchestrator</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#e879f9"></span> Network</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:#fb923c"></span> File Share</div>
                                            <div class="legend-item"><span class="legend-dot" style="background:transparent;border:2px dashed #ef4444"></span> Dependency</div>
                                        </div>
                                        <div id="wl-topology-container" style="height:550px;background:#0d1117;border-radius:8px;border:1px solid #30363d;"></div>
                                    </div>
                                </div>
                                <div class="card-dark mb-3" id="topo-detail-panel" style="display:none;">
                                    <div class="card-header"><i class="bi bi-info-circle me-2"></i>Selected Node Details</div>
                                    <div class="card-body p-3" id="topo-detail-content"></div>
                                </div>
                            </div>

                            <!-- ===== ASSESSMENT ===== -->
                            <div class="tab-pane fade" id="pane-assessment">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="assess-view-vms" onclick="switchAssessView('vms')">
                                            <i class="bi bi-pc-display me-1"></i>VMs
                                        </button>
                                        <button class="btn btn-outline-light" id="assess-view-wl" onclick="switchAssessView('wl')" style="display:none">
                                            <i class="bi bi-layers me-1"></i>Workloads
                                        </button>
                                    </div>
                                </div>
                                <!-- VM Assessment view -->
                                <div id="assess-vms-view">
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control search-box" id="assess-search"
                                                   placeholder="ðŸ” Search VMs by name, OS, host, SKU...">
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="assess-readiness-filter">
                                                <option value="">All Readiness</option>
                                                <option value="Ready">Ready</option>
                                                <option value="Ready with conditions">Conditional</option>
                                                <option value="Not Ready">Not Ready</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="assess-os-filter">
                                                <option value="">All OS</option>
                                                <option value="windows">Windows</option>
                                                <option value="linux">Linux</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="assess-power-filter">
                                                <option value="">All States</option>
                                                <option value="poweredOn">Powered On</option>
                                                <option value="poweredOff">Powered Off</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="text-muted mt-2 d-inline-block" id="assess-count">0 VMs</span>
                                        </div>
                                    </div>
                                    <div class="card-dark mb-4">
                                        <div class="assessment-scroll">
                                            <table class="table table-sm table-dark-custom mb-0" id="assess-table">
                                                <thead>
                                                    <tr>
                                                        <th style="cursor:pointer" onclick="sortAssessment('name')">VM Name <i class="bi bi-arrow-down-up"></i></th>
                                                        <th>Power</th>
                                                        <th>OS</th>
                                                        <th style="cursor:pointer" onclick="sortAssessment('cpu')">vCPU <i class="bi bi-arrow-down-up"></i></th>
                                                        <th style="cursor:pointer" onclick="sortAssessment('mem')">RAM (GB) <i class="bi bi-arrow-down-up"></i></th>
                                                        <th style="cursor:pointer" onclick="sortAssessment('disk')">Disk (GB) <i class="bi bi-arrow-down-up"></i></th>
                                                        <th>Azure SKU</th>
                                                        <th>Disk Type</th>
                                                        <th style="cursor:pointer" onclick="sortAssessment('cost')">Monthly $ <i class="bi bi-arrow-down-up"></i></th>
                                                        <th>Readiness</th>
                                                        <th style="cursor:pointer" onclick="sortAssessment('confidence')">Confidence <i class="bi bi-arrow-down-up"></i></th>
                                                        <th>Issues</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="assess-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- Workload Assessment view (shown after discovery) -->
                                <div id="assess-wl-view" style="display:none;">
                                    <div class="card-dark">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-clipboard-check me-2"></i>Azure Service Recommendations</span>
                                            <div class="d-flex gap-2 align-items-center">
                                                <span class="badge bg-secondary" id="wl-override-count" style="display:none">0 overrides</span>
                                                <input type="text" class="form-control form-control-sm search-box" style="width:250px"
                                                       placeholder="ðŸ” Search..." id="wl-assess-search" oninput="filterWorkloadAssessment()">
                                            </div>
                                        </div>
                                        <div class="assessment-scroll">
                                            <table class="table table-sm table-dark-custom mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>VM</th>
                                                        <th>Workload</th>
                                                        <th>Type</th>
                                                        <th>Source</th>
                                                        <th>Recommended Azure Service</th>
                                                        <th>Approach</th>
                                                        <th>Complexity</th>
                                                        <th title="Avg CPU %">CPU %</th>
                                                        <th title="Avg Memory MB">Mem MB</th>
                                                        <th title="Avg Connections">Conn</th>
                                                        <th>Est. $/mo</th>
                                                        <th>Confidence</th>
                                                        <th>What-If</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="wl-assess-tbody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===== SIMULATION ===== -->
                            <div class="tab-pane fade" id="pane-simulation">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-light active" id="sim-view-vms" onclick="switchSimView('vms')">
                                            <i class="bi bi-pc-display me-1"></i>VMs
                                        </button>
                                        <button class="btn btn-outline-light" id="sim-view-wl" onclick="switchSimView('wl')" style="display:none">
                                            <i class="bi bi-layers me-1"></i>Workloads
                                        </button>
                                    </div>
                                </div>
                                <!-- VM Simulation view -->
                                <div id="sim-vms-view">
                                    <div class="row g-4 mb-4">
                                        <div class="col-lg-5">
                                            <div class="sim-control mb-3">
                                                <h5 class="mb-3"><i class="bi bi-sliders me-2"></i>Simulation Parameters</h5>
                                                <label class="form-label">Target Azure Region</label>
                                                <select class="form-select mb-3" id="sim-region">
                                                    <option value="eastus">East US (baseline)</option>
                                                    <option value="westus2">West US 2 (+2%)</option>
                                                    <option value="westeurope">West Europe (+15%)</option>
                                                    <option value="northeurope">North Europe (+12%)</option>
                                                    <option value="southeastasia">Southeast Asia (+10%)</option>
                                                    <option value="centralindia">Central India (-12%)</option>
                                                    <option value="japaneast">Japan East (+18%)</option>
                                                    <option value="australiaeast">Australia East (+20%)</option>
                                                    <option value="uksouth">UK South (+14%)</option>
                                                    <option value="canadacentral">Canada Central (+5%)</option>
                                                </select>
                                                <label class="form-label">Pricing Model</label>
                                                <select class="form-select mb-3" id="sim-pricing">
                                                    <option value="pay_as_you_go">Pay-As-You-Go</option>
                                                    <option value="1_year_ri">1-Year Reserved Instance (-38%)</option>
                                                    <option value="3_year_ri">3-Year Reserved Instance (-60%)</option>
                                                    <option value="savings_plan_1yr">1-Year Savings Plan (-35%)</option>
                                                    <option value="savings_plan_3yr">3-Year Savings Plan (-55%)</option>
                                                </select>
                                                <label class="form-label">Migration Waves</label>
                                                <input type="range" class="form-range" id="sim-waves" min="1" max="8" value="3">
                                                <div class="text-muted small mb-3">Waves: <span id="sim-waves-val">3</span></div>
                                                <label class="form-label">VM Selection</label>
                                                <select class="form-select mb-3" id="sim-vm-filter">
                                                    <option value="all">All VMs</option>
                                                    <option value="powered_on">Powered On Only</option>
                                                    <option value="ready">Ready Only</option>
                                                    <option value="windows">Windows Only</option>
                                                    <option value="linux">Linux Only</option>
                                                </select>
                                                <button class="btn btn-azure w-100 mt-2" onclick="runSimulation()">
                                                    <i class="bi bi-play-fill me-1"></i> Run Simulation
                                                </button>
                                            </div>
                                            <div class="sim-control" id="sim-cost-card" style="display:none;">
                                                <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>Cost Comparison</h6>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Original (Pay-As-You-Go)</span>
                                                    <span id="sim-original-cost" class="fw-bold">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Simulated Monthly</span>
                                                    <span id="sim-new-cost" class="fw-bold cost-highlight" style="font-size:1.2rem">â€”</span>
                                                </div>
                                                <hr style="border-color:#30363d">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Monthly Savings</span>
                                                    <span id="sim-savings-monthly" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Annual Savings</span>
                                                    <span id="sim-savings-annual" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-muted">Savings %</span>
                                                    <span id="sim-savings-pct" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-7">
                                            <div id="sim-placeholder" class="text-center text-muted py-5">
                                                <i class="bi bi-lightning-charge" style="font-size:4rem;opacity:0.3"></i>
                                                <p class="mt-3">Configure parameters and click <strong>Run Simulation</strong> to see results.</p>
                                            </div>
                                            <div id="sim-whatif-comparison" style="display:none;">
                                                <div class="card-dark mb-3">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <span><i class="bi bi-arrow-left-right me-2"></i>Original vs What-If Preferences</span>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <span class="badge bg-secondary" id="sim-override-count">0 overrides</span>
                                                            <button class="btn btn-sm" style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);" onclick="clearAllOverrides()" title="Clear all saved preferences">
                                                                <i class="bi bi-trash me-1"></i>Clear All
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <div class="row g-3 mb-3">
                                                            <div class="col-md-3">
                                                                <div class="stat-card text-center">
                                                                    <div class="stat-label">Fleet Original</div>
                                                                    <div class="stat-value" style="font-size:1.4rem" id="cmp-fleet-original">â€”</div>
                                                                    <div class="small text-muted">Monthly (Pay-As-You-Go)</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="stat-card text-center">
                                                                    <div class="stat-label">Fleet Adjusted</div>
                                                                    <div class="stat-value" style="font-size:1.4rem;color:#50e6ff" id="cmp-fleet-adjusted">â€”</div>
                                                                    <div class="small text-muted">With What-If Applied</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="stat-card text-center">
                                                                    <div class="stat-label">Fleet Savings</div>
                                                                    <div style="font-size:1.4rem;font-weight:700" id="cmp-fleet-savings">â€”</div>
                                                                    <div class="small text-muted" id="cmp-fleet-savings-pct">â€”</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="stat-card text-center">
                                                                    <div class="stat-label">Overrides Impact</div>
                                                                    <div style="font-size:1.4rem;font-weight:700" id="cmp-override-savings">â€”</div>
                                                                    <div class="small text-muted" id="cmp-override-detail">â€”</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="assessment-scroll" style="max-height:350px;">
                                                            <table class="table table-sm table-dark-custom mb-0">
                                                                <thead>
                                                                    <tr>
                                                                        <th>VM Name</th>
                                                                        <th>Original SKU</th>
                                                                        <th>Original $/mo</th>
                                                                        <th><i class="bi bi-arrow-right"></i></th>
                                                                        <th>What-If SKU</th>
                                                                        <th>Region</th>
                                                                        <th>Pricing</th>
                                                                        <th>What-If $/mo</th>
                                                                        <th>Delta</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="cmp-tbody"></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="sim-results" style="display:none;">
                                                <div class="card-dark mb-3">
                                                    <div class="card-header"><i class="bi bi-graph-up me-2"></i>12-Month Migration Cost Projection</div>
                                                    <div class="card-body p-3">
                                                        <canvas id="chart-sim-projection" height="250"></canvas>
                                                    </div>
                                                </div>
                                                <div class="card-dark mb-3">
                                                    <div class="card-header"><i class="bi bi-layers me-2"></i>Migration Wave Plan</div>
                                                    <div class="card-body p-3" id="sim-waves-container"></div>
                                                </div>
                                                <div class="card-dark">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <span><i class="bi bi-table me-2"></i>VM-Level Simulation Details</span>
                                                        <input type="text" class="form-control form-control-sm search-box"
                                                               style="width:250px" placeholder="ðŸ” Search..." id="sim-search">
                                                    </div>
                                                    <div class="assessment-scroll">
                                                        <table class="table table-sm table-dark-custom mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>VM Name</th>
                                                                    <th>Original SKU</th>
                                                                    <th>Simulated SKU</th>
                                                                    <th>Original $/mo</th>
                                                                    <th>Simulated $/mo</th>
                                                                    <th>Savings</th>
                                                                    <th>Readiness</th>
                                                                    <th>Wave</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="sim-tbody"></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Workload Simulation view (shown after discovery) -->
                                <div id="sim-wl-view" style="display:none;">
                                    <div class="row g-4">
                                        <div class="col-lg-4">
                                            <div class="sim-control mb-3">
                                                <h5 class="mb-3"><i class="bi bi-sliders me-2"></i>Simulation Parameters</h5>
                                                <label class="form-label">Target Azure Region</label>
                                                <select class="form-select mb-3" id="wlsim-region">
                                                    <option value="eastus">East US (baseline)</option>
                                                    <option value="westus2">West US 2 (+2%)</option>
                                                    <option value="westeurope">West Europe (+12%)</option>
                                                    <option value="northeurope">North Europe (+10%)</option>
                                                    <option value="southeastasia">Southeast Asia (+8%)</option>
                                                    <option value="centralindia">Central India (-10%)</option>
                                                    <option value="japaneast">Japan East (+15%)</option>
                                                    <option value="australiaeast">Australia East (+18%)</option>
                                                    <option value="uksouth">UK South (+12%)</option>
                                                    <option value="canadacentral">Canada Central (+4%)</option>
                                                </select>
                                                <label class="form-label">Pricing Model</label>
                                                <select class="form-select mb-3" id="wlsim-pricing">
                                                    <option value="pay_as_you_go">Pay-As-You-Go</option>
                                                    <option value="1_year_ri">1-Year Reserved (-35%)</option>
                                                    <option value="3_year_ri">3-Year Reserved (-55%)</option>
                                                    <option value="dev_test">Dev/Test (-45%)</option>
                                                    <option value="enterprise_agreement">Enterprise Agreement (-20%)</option>
                                                </select>
                                                <label class="form-label">Migration Waves</label>
                                                <input type="range" class="form-range" id="wlsim-waves" min="1" max="8" value="3">
                                                <div class="text-muted small mb-3">Waves: <span id="wlsim-waves-val">3</span></div>
                                                <label class="form-label">Workload Type</label>
                                                <select class="form-select mb-3" id="wlsim-filter">
                                                    <option value="all">All Workloads</option>
                                                    <option value="database">Databases Only</option>
                                                    <option value="webapp">Web Apps Only</option>
                                                    <option value="container">Containers / Orchestrators Only</option>
                                                    <option value="network">Networks Only</option>
                                                    <option value="fileshare">File Shares Only</option>
                                                </select>
                                                <button class="btn btn-azure w-100 mt-2" onclick="runWlSimulation()">
                                                    <i class="bi bi-play-fill me-1"></i> Run Simulation
                                                </button>
                                            </div>
                                            <div class="sim-control" id="wlsim-cost-card" style="display:none;">
                                                <h6 class="mb-3"><i class="bi bi-calculator me-2"></i>Cost Comparison</h6>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Original (Pay-As-You-Go)</span>
                                                    <span id="wlsim-original-cost" class="fw-bold">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Simulated Monthly</span>
                                                    <span id="wlsim-new-cost" class="fw-bold cost-highlight" style="font-size:1.2rem">â€”</span>
                                                </div>
                                                <hr style="border-color:#30363d">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Monthly Savings</span>
                                                    <span id="wlsim-savings-monthly" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="text-muted">Annual Savings</span>
                                                    <span id="wlsim-savings-annual" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-muted">Savings %</span>
                                                    <span id="wlsim-savings-pct" class="fw-bold cost-savings">â€”</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div id="wlsim-placeholder" class="text-center text-muted py-5">
                                                <i class="bi bi-lightning-charge" style="font-size:4rem;opacity:0.3"></i>
                                                <p class="mt-3">Configure parameters and click <strong>Run Simulation</strong> to see workload migration results.</p>
                                            </div>
                                            <div id="wlsim-results" style="display:none;">
                                                <div class="row g-3 mb-3" id="wlsim-type-cards"></div>
                                                <div class="card-dark mb-3">
                                                    <div class="card-header"><i class="bi bi-graph-up me-2"></i>12-Month Workload Migration Cost Projection</div>
                                                    <div class="card-body p-3">
                                                        <canvas id="chart-wlsim-projection" height="250"></canvas>
                                                    </div>
                                                </div>
                                                <div class="card-dark mb-3">
                                                    <div class="card-header"><i class="bi bi-layers me-2"></i>Migration Wave Plan</div>
                                                    <div class="card-body p-3" id="wlsim-waves-container"></div>
                                                </div>
                                                <div class="card-dark">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <span><i class="bi bi-table me-2"></i>Workload-Level Simulation Details</span>
                                                        <input type="text" class="form-control form-control-sm search-box"
                                                               style="width:250px" placeholder="ðŸ” Search..." id="wlsim-search" oninput="filterWlSimTable()">
                                                    </div>
                                                    <div class="assessment-scroll">
                                                        <table class="table table-sm table-dark-custom mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th>VM / Workload</th>
                                                                    <th>Type</th>
                                                                    <th>Original Service</th>
                                                                    <th>Simulated Service</th>
                                                                    <th>Original $/mo</th>
                                                                    <th>Simulated $/mo</th>
                                                                    <th>Savings</th>
                                                                    <th>Complexity</th>
                                                                    <th>Wave</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="wlsim-tbody"></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- /pane-simulation -->

                        </div><!-- /tab-content -->
                    </div>
                </div>
            </div><!-- /pane-workloads -->

            <!-- ==================== BUSINESS CASE ==================== -->
            <div class="tab-pane fade" id="pane-businesscase" role="tabpanel">

                <!-- Controls Bar -->
                <div class="card mb-3" style="background:var(--card-bg);border:1px solid var(--border);">
                    <div class="card-body py-2">
                        <div class="row align-items-end g-2">
                            <div class="col-auto">
                                <label class="form-label small mb-1">Pricing Model</label>
                                <select id="bc-pricing" class="form-select form-select-sm" style="min-width:170px">
                                    <option value="pay_as_you_go">Pay-As-You-Go</option>
                                    <option value="1_year_ri">1-Year Reserved</option>
                                    <option value="3_year_ri" selected>3-Year Reserved</option>
                                    <option value="savings_plan_1yr">Savings Plan 1yr</option>
                                    <option value="savings_plan_3yr">Savings Plan 3yr</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-1">Target Region</label>
                                <select id="bc-region" class="form-select form-select-sm" style="min-width:150px">
                                    <option value="eastus" selected>East US</option>
                                    <option value="westus2">West US 2</option>
                                    <option value="westeurope">West Europe</option>
                                    <option value="northeurope">North Europe</option>
                                    <option value="southeastasia">Southeast Asia</option>
                                    <option value="centralindia">Central India</option>
                                    <option value="uksouth">UK South</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-1">Analysis Period</label>
                                <select id="bc-years" class="form-select form-select-sm" style="min-width:100px">
                                    <option value="1">1 Year</option>
                                    <option value="3" selected>3 Years</option>
                                    <option value="5">5 Years</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary btn-sm" onclick="loadBusinessCase()">
                                    <i class="bi bi-calculator me-1"></i>Generate Business Case
                                </button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-light btn-sm" onclick="exportBusinessCasePDF()" id="bc-export-btn" disabled>
                                    <i class="bi bi-file-earmark-pdf me-1"></i>Export Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="bc-loading" class="text-center py-5 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 text-muted">Generating business case...</div>
                </div>

                <!-- Empty State -->
                <div id="bc-empty" class="text-center py-5">
                    <i class="bi bi-briefcase" style="font-size:3rem;color:var(--text-muted)"></i>
                    <h5 class="mt-3" style="color:var(--text-muted)">Business Case Generator</h5>
                    <p class="text-muted">Click <strong>Generate Business Case</strong> to create a CxO-ready migration business case<br>comparing your on-premises TCO against Azure.</p>
                </div>

                <!-- Results -->
                <div id="bc-results" class="d-none">

                    <!-- Executive Summary Banner -->
                    <div class="card mb-3" style="background:linear-gradient(135deg,#1a3a5c 0%,#0d2137 100%);border:none;">
                        <div class="card-body">
                            <h4 class="text-white mb-1"><i class="bi bi-briefcase me-2"></i>Executive Summary â€” Azure Migration Business Case</h4>
                            <small class="text-white-50" id="bc-subtitle"></small>
                            <div class="row g-3 mt-3">
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 rounded" style="background:rgba(255,255,255,0.08)">
                                        <div class="text-white-50 small">Annual Savings</div>
                                        <div class="text-white fs-3 fw-bold" id="bc-annual-savings">â€”</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 rounded" style="background:rgba(255,255,255,0.08)">
                                        <div class="text-white-50 small">Cost Reduction</div>
                                        <div class="fs-3 fw-bold" style="color:#58d68d" id="bc-savings-pct">â€”</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 rounded" style="background:rgba(255,255,255,0.08)">
                                        <div class="text-white-50 small">Payback Period</div>
                                        <div class="text-white fs-3 fw-bold" id="bc-payback">â€”</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-3 rounded" style="background:rgba(255,255,255,0.08)">
                                        <div class="text-white-50 small"><span id="bc-years-label">3</span>-Year TCO Savings</div>
                                        <div class="fs-3 fw-bold" style="color:#5dade2" id="bc-tco-savings">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fleet Overview Cards -->
                    <div class="row g-3 mb-3">
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-pc-display"></i></div>
                                <div class="stat-value" id="bc-total-vms">â€”</div>
                                <div class="stat-label">Total VMs</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-hdd-rack"></i></div>
                                <div class="stat-value" id="bc-total-hosts">â€”</div>
                                <div class="stat-label">ESXi Hosts</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-cpu"></i></div>
                                <div class="stat-value" id="bc-total-vcpus">â€”</div>
                                <div class="stat-label">Total vCPUs</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-memory"></i></div>
                                <div class="stat-value" id="bc-total-mem">â€”</div>
                                <div class="stat-label">Memory (GB)</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-hdd"></i></div>
                                <div class="stat-value" id="bc-total-storage">â€”</div>
                                <div class="stat-label">Storage (TB)</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-2">
                            <div class="stat-card text-center">
                                <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                                <div class="stat-value" style="color:#58d68d" id="bc-readiness">â€”</div>
                                <div class="stat-label">Migration Ready</div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Charts Row -->
                    <div class="row g-3 mb-3">
                        <!-- TCO Comparison Bar Chart -->
                        <div class="col-md-6">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-bar-chart me-1"></i>Total Cost of Ownership Comparison</h6>
                                    <div style="height:320px"><canvas id="chart-bc-tco"></canvas></div>
                                </div>
                            </div>
                        </div>
                        <!-- Yearly Projection Line Chart -->
                        <div class="col-md-6">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-graph-up me-1"></i>Cumulative Savings Over Time</h6>
                                    <div style="height:320px"><canvas id="chart-bc-cumulative"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cost Breakdown Row -->
                    <div class="row g-3 mb-3">
                        <!-- On-Prem Breakdown Doughnut -->
                        <div class="col-md-4">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-building me-1"></i>On-Premises Cost Breakdown</h6>
                                    <div style="height:280px"><canvas id="chart-bc-onprem"></canvas></div>
                                    <div class="text-center mt-2">
                                        <span class="fs-5 fw-bold text-warning" id="bc-onprem-monthly">â€”</span>
                                        <span class="text-muted small">/month</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Azure Breakdown Doughnut -->
                        <div class="col-md-4">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-cloud me-1"></i>Azure Cost Breakdown</h6>
                                    <div style="height:280px"><canvas id="chart-bc-azure"></canvas></div>
                                    <div class="text-center mt-2">
                                        <span class="fs-5 fw-bold" style="color:#5dade2" id="bc-azure-monthly">â€”</span>
                                        <span class="text-muted small">/month</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Year-over-Year Bar Chart -->
                        <div class="col-md-4">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-calendar3 me-1"></i>Year-over-Year Cost</h6>
                                    <div style="height:280px"><canvas id="chart-bc-yoy"></canvas></div>
                                    <div class="text-center mt-2">
                                        <span class="text-muted small">Includes 3% on-prem inflation</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Benefits -->
                    <div class="card mb-3" style="background:var(--card-bg);border:1px solid var(--border)">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-star me-1"></i>Key Benefits of Azure Migration</h6>
                            <div class="row g-3" id="bc-benefits-grid"></div>
                        </div>
                    </div>

                    <!-- Migration Investment & Risks -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-cash-stack me-1"></i>Migration Investment</h6>
                                    <table class="table table-sm table-dark mb-0" style="background:transparent">
                                        <tbody id="bc-migration-table"></tbody>
                                        <tfoot>
                                            <tr class="fw-bold" style="border-top:2px solid var(--border)">
                                                <td>Total One-Time Investment</td>
                                                <td class="text-end" id="bc-migration-total">â€”</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100" style="background:var(--card-bg);border:1px solid var(--border)">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-exclamation-triangle me-1"></i>Risk Assessment</h6>
                                    <div id="bc-risks-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assumptions Accordion -->
                    <div class="accordion mb-3" id="bc-assumptions-accordion">
                        <div class="accordion-item" style="background:var(--card-bg);border:1px solid var(--border)">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#bc-assumptions-body"
                                        style="background:var(--card-bg);color:var(--text)">
                                    <i class="bi bi-info-circle me-2"></i>Cost Assumptions &amp; Methodology
                                </button>
                            </h2>
                            <div id="bc-assumptions-body" class="accordion-collapse collapse" data-bs-parent="#bc-assumptions-accordion">
                                <div class="accordion-body">
                                    <div class="row" id="bc-assumptions-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div><!-- /bc-results -->

            </div><!-- /pane-businesscase -->

            <!-- ==================== ENRICHMENT DATA LOOP ==================== -->
            <div class="tab-pane fade" id="pane-enrichment" role="tabpanel">

                <!-- Status Bar -->
                <div class="row g-3 mb-4" id="enrichment-status-cards">
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-pc-display"></i></div>
                            <div class="stat-value" id="enr-total-vms">0</div>
                            <div class="stat-label">Total VMs</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-check-circle" style="color:#10b981"></i></div>
                            <div class="stat-value" id="enr-enriched-vms" style="color:#10b981">0</div>
                            <div class="stat-label">Enriched VMs</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-pie-chart" style="color:#0078d4"></i></div>
                            <div class="stat-value" id="enr-coverage" style="color:#0078d4">0%</div>
                            <div class="stat-label">Coverage</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-arrow-up-circle" style="color:#10b981"></i></div>
                            <div class="stat-value" id="enr-avg-boost" style="color:#10b981">+0%</div>
                            <div class="stat-label">Avg Confidence Boost</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
                            <div class="stat-value" id="enr-tools-used">0</div>
                            <div class="stat-label">Tools Integrated</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="stat-card text-center">
                            <div class="stat-icon"><i class="bi bi-upload"></i></div>
                            <div class="stat-value" id="enr-ingestions">0</div>
                            <div class="stat-label">Data Ingestions</div>
                        </div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div class="card mb-4" style="background:var(--card-bg);border:1px solid var(--border);">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-cloud-arrow-up me-2"></i>Upload Monitoring Telemetry</h5>
                        <p class="text-muted small mb-3">Import monitoring data from your APM/infrastructure tools to enrich the assessment with real-world performance metrics.
                            This improves confidence scores by validating discovered configurations against production telemetry.</p>

                        <div class="row align-items-end g-3">
                            <div class="col-md-4">
                                <label class="form-label small">Monitoring Tool</label>
                                <select id="enr-tool-select" class="form-select form-select-sm">
                                    <option value="">-- Select tool --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">JSON Data File</label>
                                <input type="file" id="enr-file-input" accept=".json" class="form-control form-control-sm">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-primary" onclick="uploadEnrichmentData()">
                                    <i class="bi bi-upload me-1"></i> Upload &amp; Ingest
                                </button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-secondary" onclick="generateSampleEnrichment()">
                                    <i class="bi bi-magic me-1"></i> Generate Sample Data
                                </button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-danger" onclick="clearEnrichmentData()">
                                    <i class="bi bi-trash me-1"></i> Clear All
                                </button>
                            </div>
                        </div>
                        <div id="enr-upload-result" class="mt-3" style="display:none"></div>
                    </div>
                </div>

                <!-- Supported Tools Grid -->
                <div class="card mb-4" style="background:var(--card-bg);border:1px solid var(--border);">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-grid me-2"></i>Supported Monitoring Tools</h5>
                        <div class="row g-3" id="enr-tools-grid"></div>
                    </div>
                </div>

                <!-- Enrichment Data Table -->
                <div class="card mb-4" style="background:var(--card-bg);border:1px solid var(--border);">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-table me-2"></i>Enrichment Telemetry Data</h5>
                        <p class="text-muted small mb-2">Normalised monitoring data mapped to discovered VMs. Confidence boost is applied to both VM and workload assessments.</p>
                        <div class="table-responsive" style="max-height:500px;overflow:auto">
                            <table class="table table-sm table-hover" style="font-size:0.82rem">
                                <thead class="sticky-top" style="background:var(--card-bg)">
                                    <tr>
                                        <th>VM Name</th>
                                        <th>Tool</th>
                                        <th>Avg CPU%</th>
                                        <th>P95 CPU%</th>
                                        <th>Avg Mem%</th>
                                        <th>P95 Mem%</th>
                                        <th>IOPS</th>
                                        <th>Net kBps</th>
                                        <th>Resp Time</th>
                                        <th>Error Rate</th>
                                        <th>Dependencies</th>
                                        <th>Period</th>
                                        <th>Samples</th>
                                        <th>Confidence Boost</th>
                                    </tr>
                                </thead>
                                <tbody id="enr-data-tbody"></tbody>
                            </table>
                        </div>
                        <div id="enr-empty-msg" class="text-center text-muted py-4" style="display:none">
                            <i class="bi bi-inbox" style="font-size:2rem"></i>
                            <p class="mt-2">No enrichment data yet. Upload monitoring telemetry or generate sample data to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Confidence Impact Chart -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card" style="background:var(--card-bg);border:1px solid var(--border);">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-bar-chart me-2"></i>Confidence Score Distribution (Before vs After)</h6>
                                <canvas id="enr-confidence-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="background:var(--card-bg);border:1px solid var(--border);">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-pie-chart me-2"></i>Metrics Coverage</h6>
                                <canvas id="enr-metrics-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingestion History -->
                <div class="card mt-4" style="background:var(--card-bg);border:1px solid var(--border);">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-clock-history me-2"></i>Ingestion History</h5>
                        <div class="table-responsive" style="max-height:300px;overflow:auto">
                            <table class="table table-sm" style="font-size:0.82rem">
                                <thead class="sticky-top" style="background:var(--card-bg)">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Tool</th>
                                        <th>Matched</th>
                                        <th>Unmatched</th>
                                        <th>Total Records</th>
                                    </tr>
                                </thead>
                                <tbody id="enr-history-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div><!-- /pane-enrichment -->

        </div><!-- /tab-content -->
    </div><!-- /container -->

    <!-- Workload What-If Modal -->
    <div class="vm-modal-backdrop" id="wl-whatif-backdrop" onclick="if(event.target===this)closeWlWhatIf()">
        <div class="vm-modal">
            <div class="vm-modal-header">
                <h5><i class="bi bi-layers me-2"></i>Workload What-If: <span id="wl-whatif-title"></span></h5>
                <button class="vm-modal-close" onclick="closeWlWhatIf()">&times;</button>
            </div>
            <div class="vm-modal-body">
                <!-- Workload Details -->
                <div class="vm-detail-grid" id="wl-whatif-details"></div>

                <!-- What-If Controls -->
                <h6 class="mb-2"><i class="bi bi-sliders me-2"></i>What-If Parameters</h6>
                <div class="whatif-controls">
                    <select class="form-select form-select-sm" id="wl-whatif-region" onchange="recalcWlWhatIf()">
                        <option value="eastus">East US</option>
                        <option value="westus2">West US 2 (+2%)</option>
                        <option value="westeurope">West Europe (+12%)</option>
                        <option value="northeurope">North Europe (+10%)</option>
                        <option value="southeastasia">Southeast Asia (+8%)</option>
                        <option value="centralindia">Central India (-10%)</option>
                        <option value="japaneast">Japan East (+15%)</option>
                        <option value="australiaeast">Australia East (+18%)</option>
                        <option value="uksouth">UK South (+12%)</option>
                        <option value="canadacentral">Canada Central (+4%)</option>
                    </select>
                    <select class="form-select form-select-sm" id="wl-whatif-pricing" onchange="recalcWlWhatIf()">
                        <option value="pay_as_you_go">Pay-As-You-Go</option>
                        <option value="1_year_ri">1-Year Reserved (-35%)</option>
                        <option value="3_year_ri">3-Year Reserved (-55%)</option>
                        <option value="dev_test">Dev/Test (-45%)</option>
                        <option value="enterprise_agreement">Enterprise Agreement (-20%)</option>
                    </select>
                </div>

                <!-- Cost Comparison -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Current Recommendation</div>
                            <div style="font-size:1.1rem;font-weight:700;color:#8b949e" id="wl-whatif-current-cost">â€”</div>
                            <div class="small text-muted" id="wl-whatif-current-svc">â€”</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Selected Configuration</div>
                            <div class="whatif-cost-display" id="wl-whatif-selected-cost">â€”</div>
                            <div class="small text-muted" id="wl-whatif-selected-svc">â€”</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Savings vs Current</div>
                            <div class="whatif-savings" id="wl-whatif-delta">â€”</div>
                            <div class="small text-muted" id="wl-whatif-delta-annual">â€”</div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Comparison Chart -->
                <div class="card-dark mb-3">
                    <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Cost Across All Pricing Models (selected service)</div>
                    <div class="card-body p-3"><canvas id="chart-wl-whatif-pricing" height="180"></canvas></div>
                </div>

                <!-- Service Options Grid -->
                <h6 class="mb-2"><i class="bi bi-grid me-2"></i>Select Azure Service <span class="text-muted small">(click to compare)</span></h6>
                <div class="sku-grid" id="wl-whatif-svc-grid"></div>

                <!-- Migration Steps -->
                <div class="card-dark mt-3 mb-3" id="wl-whatif-steps-card" style="display:none">
                    <div class="card-header"><i class="bi bi-list-check me-2"></i>Migration Steps</div>
                    <div class="card-body p-3" id="wl-whatif-steps-body"></div>
                </div>

                <!-- Save Preference Bar -->
                <div class="d-flex justify-content-between align-items-center mt-3 p-3" style="background:rgba(0,120,212,0.06);border:1px solid #30363d;border-radius:10px;">
                    <div>
                        <span id="wl-whatif-saved-badge" style="display:none;">
                            <span class="badge badge-ready me-2"><i class="bi bi-check-circle me-1"></i>Preference Saved</span>
                            <span class="small text-muted" id="wl-whatif-saved-info"></span>
                        </span>
                        <span id="wl-whatif-unsaved-badge">
                            <span class="badge bg-secondary"><i class="bi bi-pencil me-1"></i>Unsaved</span>
                            <span class="small text-muted ms-2">Select service, region &amp; pricing, then save</span>
                        </span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm" style="background:#21262d;color:#8b949e;border:1px solid #30363d;" id="wl-whatif-remove-btn" onclick="removeWlWhatIfPreference()" style="display:none;">
                            <i class="bi bi-trash me-1"></i>Remove
                        </button>
                        <button class="btn btn-sm btn-azure" onclick="saveWlWhatIfPreference()">
                            <i class="bi bi-save me-1"></i>Save as My Preference
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VM What-If Modal -->
    <div class="vm-modal-backdrop" id="vm-whatif-backdrop" onclick="if(event.target===this)closeWhatIf()">
        <div class="vm-modal">
            <div class="vm-modal-header">
                <h5><i class="bi bi-pc-display me-2"></i>VM What-If Analysis: <span id="whatif-vm-name"></span></h5>
                <button class="vm-modal-close" onclick="closeWhatIf()">&times;</button>
            </div>
            <div class="vm-modal-body">
                <!-- VM Details -->
                <div class="vm-detail-grid" id="whatif-details"></div>

                <!-- Performance Trends (sparklines) -->
                <div id="whatif-perf-section" style="display:none;">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="card-dark">
                                <div class="card-header py-2" style="font-size:0.85rem"><i class="bi bi-cpu me-1"></i>CPU Usage
                                    <span class="float-end small text-muted" id="perf-cpu-stat"></span>
                                </div>
                                <div class="card-body p-2">
                                    <canvas id="perf-chart-cpu" height="80"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-dark">
                                <div class="card-header py-2" style="font-size:0.85rem"><i class="bi bi-memory me-1"></i>Memory Usage
                                    <span class="float-end small text-muted" id="perf-mem-stat"></span>
                                </div>
                                <div class="card-body p-2">
                                    <canvas id="perf-chart-mem" height="80"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card-dark">
                                <div class="card-header py-2" style="font-size:0.85rem"><i class="bi bi-hdd me-1"></i>Disk IOPS
                                    <span class="float-end small text-muted" id="perf-iops-stat"></span>
                                </div>
                                <div class="card-body p-2">
                                    <canvas id="perf-chart-iops" height="80"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Disks & NICs -->
                <div class="row g-3 mb-3" id="whatif-infra-row"></div>

                <!-- What-If Controls -->
                <h6 class="mb-2"><i class="bi bi-sliders me-2"></i>What-If Parameters</h6>
                <div class="whatif-controls">
                    <select class="form-select form-select-sm" id="whatif-region" onchange="recalcWhatIf()">
                        <option value="eastus">East US</option>
                        <option value="westus2">West US 2 (+2%)</option>
                        <option value="westeurope">West Europe (+15%)</option>
                        <option value="northeurope">North Europe (+12%)</option>
                        <option value="southeastasia">Southeast Asia (+10%)</option>
                        <option value="centralindia">Central India (-12%)</option>
                        <option value="japaneast">Japan East (+18%)</option>
                        <option value="australiaeast">Australia East (+20%)</option>
                        <option value="uksouth">UK South (+14%)</option>
                        <option value="canadacentral">Canada Central (+5%)</option>
                    </select>
                    <select class="form-select form-select-sm" id="whatif-pricing" onchange="recalcWhatIf()">
                        <option value="pay_as_you_go">Pay-As-You-Go</option>
                        <option value="1_year_ri">1-Year RI (-38%)</option>
                        <option value="3_year_ri">3-Year RI (-60%)</option>
                        <option value="savings_plan_1yr">Savings Plan 1yr (-35%)</option>
                        <option value="savings_plan_3yr">Savings Plan 3yr (-55%)</option>
                    </select>
                    <label class="form-check form-switch d-flex align-items-center gap-2 ms-2">
                        <input class="form-check-input" type="checkbox" id="whatif-show-unfit" onchange="renderSkuGrid()">
                        <span class="small text-muted">Show undersized SKUs</span>
                    </label>
                </div>

                <!-- Cost Result -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Current Recommendation</div>
                            <div style="font-size:1.1rem;font-weight:700;color:#8b949e" id="whatif-current-cost">â€”</div>
                            <div class="small text-muted" id="whatif-current-sku">â€”</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Selected Configuration</div>
                            <div class="whatif-cost-display" id="whatif-selected-cost">â€”</div>
                            <div class="small text-muted" id="whatif-selected-sku">â€”</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card text-center">
                            <div class="stat-label">Savings vs Current</div>
                            <div class="whatif-savings" id="whatif-delta">â€”</div>
                            <div class="small text-muted" id="whatif-delta-annual">â€”</div>
                        </div>
                    </div>
                </div>

                <!-- All-Pricing Comparison Chart -->
                <div class="card-dark mb-3">
                    <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Cost Across All Pricing Models (selected SKU)</div>
                    <div class="card-body p-3"><canvas id="chart-whatif-pricing" height="180"></canvas></div>
                </div>

                <!-- SKU Grid -->
                <h6 class="mb-2"><i class="bi bi-grid me-2"></i>Select Azure VM SKU <span class="text-muted small">(click to compare)</span></h6>
                <div class="sku-grid" id="whatif-sku-grid"></div>

                <!-- Save Preference Bar -->
                <div class="d-flex justify-content-between align-items-center mt-3 p-3" style="background:rgba(0,120,212,0.06);border:1px solid #30363d;border-radius:10px;">
                    <div>
                        <span id="whatif-saved-badge" style="display:none;">
                            <span class="badge badge-ready me-2"><i class="bi bi-check-circle me-1"></i>Preference Saved</span>
                            <span class="small text-muted" id="whatif-saved-info"></span>
                        </span>
                        <span id="whatif-unsaved-badge">
                            <span class="badge bg-secondary"><i class="bi bi-pencil me-1"></i>Unsaved</span>
                            <span class="small text-muted ms-2">Select SKU, region &amp; pricing, then save</span>
                        </span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm" style="background:#21262d;color:#8b949e;border:1px solid #30363d;" id="whatif-remove-btn" onclick="removeWhatIfPreference()" style="display:none;">
                            <i class="bi bi-trash me-1"></i>Remove
                        </button>
                        <button class="btn btn-sm btn-azure" onclick="saveWhatIfPreference()">
                            <i class="bi bi-save me-1"></i>Save as My Preference
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ================================================================
    // GLOBAL STATE
    // ================================================================
    let summaryData = null;
    let allVMs = [];
    let assessmentSort = { col: 'name', asc: true };
    let topologyNetwork = null;
    let projectionChart = null;

    // ================================================================
    // DASHBOARD
    // ================================================================
    async function loadDashboard() {
        const res = await fetch('/api/summary');
        summaryData = await res.json();
        const s = summaryData;

        document.getElementById('card-vms').textContent = s.total_vms;
        document.getElementById('card-hosts').textContent = s.hosts;
        document.getElementById('card-vcpus').textContent = s.total_vcpus;
        document.getElementById('card-memory').textContent = s.total_memory_gb.toLocaleString();
        document.getElementById('card-disk').textContent = s.total_disk_tb;
        document.getElementById('card-cost').textContent = '$' + s.total_monthly_cost.toLocaleString();

        // Populate sidebar discovery summary
        document.getElementById('disc-sum-vms').textContent = s.total_vms;
        document.getElementById('disc-sum-vcpus').textContent = s.total_vcpus;
        document.getElementById('disc-sum-ram').textContent = s.total_memory_gb.toLocaleString();
        document.getElementById('disc-sum-disk').textContent = s.total_disk_tb;
        document.getElementById('disc-sum-hosts').textContent = s.hosts;
        document.getElementById('disc-sum-networks').textContent = s.networks || 0;
        document.getElementById('disc-sum-fileshares').textContent = s.file_shares || 0;
        document.getElementById('disc-sum-vmcost').textContent = '$' + s.total_monthly_cost.toLocaleString();
        document.getElementById('vm-summary-card').style.display = 'block';

        // Load network and file share data into inventory
        await loadInfraInventory();

        // Start perf monitor polling
        startPerfPolling();

        // Readiness chart
        new Chart(document.getElementById('chart-readiness'), {
            type: 'doughnut',
            data: {
                labels: ['Ready', 'Conditional', 'Not Ready'],
                datasets: [{
                    data: [s.ready, s.conditional, s.not_ready],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#8b949e', padding: 16 } }
                }
            }
        });

        // OS chart
        new Chart(document.getElementById('chart-os'), {
            type: 'doughnut',
            data: {
                labels: ['Windows', 'Linux', 'Other'],
                datasets: [{
                    data: [s.windows, s.linux, s.other_os],
                    backgroundColor: ['#0078d4', '#f97316', '#8b5cf6'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#8b949e', padding: 16 } }
                }
            }
        });

        // Power state chart
        new Chart(document.getElementById('chart-power'), {
            type: 'doughnut',
            data: {
                labels: ['Powered On', 'Powered Off'],
                datasets: [{
                    data: [s.powered_on, s.powered_off],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#8b949e', padding: 16 } }
                }
            }
        });

        // Family distribution bar chart
        const families = Object.keys(s.family_distribution);
        new Chart(document.getElementById('chart-family'), {
            type: 'bar',
            data: {
                labels: families,
                datasets: [{
                    label: 'VM Count',
                    data: families.map(f => s.family_distribution[f]),
                    backgroundColor: '#0078d4',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { display: false } },
                    y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
                }
            }
        });

        // Cost by family
        new Chart(document.getElementById('chart-cost-family'), {
            type: 'bar',
            data: {
                labels: families,
                datasets: [{
                    label: 'Monthly Cost ($)',
                    data: families.map(f => s.cost_by_family[f]),
                    backgroundColor: '#10b981',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { display: false } },
                    y: { ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() }, grid: { color: '#21262d' } }
                }
            }
        });

        // Folder distribution
        const folders = Object.keys(s.folder_distribution);
        new Chart(document.getElementById('chart-folders'), {
            type: 'bar',
            data: {
                labels: folders,
                datasets: [{
                    label: 'VMs',
                    data: folders.map(f => s.folder_distribution[f]),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { color: '#8b949e' }, grid: { display: false } }
                }
            }
        });
    }

    // ================================================================
    // PERFORMANCE MONITOR
    // ================================================================
    let _perfPollTimer = null;

    async function loadPerfStatus() {
        try {
            const [statusRes, summaryRes] = await Promise.all([
                fetch('/api/perf/status'),
                fetch('/api/perf/summary')
            ]);
            const status = await statusRes.json();
            const summary = await summaryRes.json();

            const section = document.getElementById('perf-status-section');
            if (section) section.style.display = 'block';

            // Status dot & label
            const dot = document.getElementById('perf-status-dot');
            const label = document.getElementById('perf-status-label');
            if (status.running) {
                dot.style.background = '#10b981';
                label.textContent = 'Collecting';
                label.style.color = '#10b981';
                document.getElementById('perf-btn-start').style.display = 'none';
                document.getElementById('perf-btn-stop').style.display = '';
            } else {
                dot.style.background = '#ef4444';
                label.textContent = 'Stopped';
                label.style.color = '#ef4444';
                document.getElementById('perf-btn-start').style.display = '';
                document.getElementById('perf-btn-stop').style.display = 'none';
            }

            // Summary stats
            if (summary.has_data) {
                document.getElementById('perf-avg-cpu').textContent = summary.avg_cpu_pct.toFixed(1) + '%';
                document.getElementById('perf-avg-mem').textContent = summary.avg_mem_pct.toFixed(1) + '%';
                document.getElementById('perf-total-iops').textContent = Math.round(summary.total_iops).toLocaleString();
                document.getElementById('perf-sample-count').textContent = status.samples_collected + ' (' + status.vms_monitored + ' VMs)';
            }

            // Last collection time
            if (status.last_collection) {
                const dt = new Date(status.last_collection);
                document.getElementById('perf-last-time').textContent = dt.toLocaleTimeString();
            }
        } catch(e) { /* silent */ }
    }

    async function perfCollectorAction(action) {
        try {
            const res = await fetch('/api/perf/' + action, { method: 'POST' });
            const data = await res.json();
            setTimeout(loadPerfStatus, 500);
        } catch(e) { console.error('Perf action failed:', e); }
    }

    function startPerfPolling() {
        if (_perfPollTimer) return;
        loadPerfStatus();
        _perfPollTimer = setInterval(loadPerfStatus, 30000); // refresh every 30s
    }

    // Track sparkline chart instances for cleanup
    let _perfSparkCharts = [];

    async function loadPerfSparklines(vmName, vmData) {
        // Destroy old charts
        _perfSparkCharts.forEach(c => { try { c.destroy(); } catch(e) {} });
        _perfSparkCharts = [];

        const section = document.getElementById('whatif-perf-section');
        if (!section) return;

        // Use perf_history from the VM info API response (last 20 samples)
        let history = vmData.perf_history || [];
        const stats = vmData.perf_stats || {};

        if (!history.length) {
            // Try fetching from perf API
            try {
                const res = await fetch('/api/perf/vm/' + encodeURIComponent(vmName));
                const data = await res.json();
                history = (data.samples || []).slice(-20);
            } catch(e) { /* silent */ }
        }

        if (!history.length) {
            section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        const labels = history.map((s, i) => {
            const d = new Date(s.ts);
            return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        });

        const chartOpts = (color, maxY) => ({
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
            scales: {
                x: { display: false },
                y: { min: 0, max: maxY, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' } }
            },
            elements: { point: { radius: 1.5 }, line: { tension: 0.3, borderWidth: 2 } }
        });

        // CPU sparkline
        const cpuCtx = document.getElementById('perf-chart-cpu');
        if (cpuCtx) {
            const ch = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: history.map(s => s.cpu_pct),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0,120,212,0.15)',
                        fill: true
                    }]
                },
                options: chartOpts('#0078d4', 100)
            });
            _perfSparkCharts.push(ch);
        }
        const cpuS = stats.cpu_pct || {};
        if (cpuS.count) document.getElementById('perf-cpu-stat').textContent = `avg ${cpuS.avg.toFixed(1)}% | p95 ${cpuS.p95.toFixed(1)}%`;

        // Memory sparkline
        const memCtx = document.getElementById('perf-chart-mem');
        if (memCtx) {
            const ch = new Chart(memCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: history.map(s => s.mem_pct),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.15)',
                        fill: true
                    }]
                },
                options: chartOpts('#10b981', 100)
            });
            _perfSparkCharts.push(ch);
        }
        const memS = stats.mem_pct || {};
        if (memS.count) document.getElementById('perf-mem-stat').textContent = `avg ${memS.avg.toFixed(1)}% | p95 ${memS.p95.toFixed(1)}%`;

        // IOPS sparkline
        const iopsCtx = document.getElementById('perf-chart-iops');
        if (iopsCtx) {
            const maxIops = Math.max(100, ...history.map(s => s.disk_iops || 0)) * 1.2;
            const ch = new Chart(iopsCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: history.map(s => s.disk_iops),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245,158,11,0.15)',
                        fill: true
                    }]
                },
                options: chartOpts('#f59e0b', maxIops)
            });
            _perfSparkCharts.push(ch);
        }
        const iopsS = stats.disk_iops || {};
        if (iopsS.count) document.getElementById('perf-iops-stat').textContent = `avg ${iopsS.avg.toFixed(0)} | p95 ${iopsS.p95.toFixed(0)}`;
    }

    // ================================================================
    // TOPOLOGY
    // ================================================================
    let physicsEnabled = true;

    async function loadTopology() {
        if (topologyNetwork) return; // already loaded
        const res = await fetch('/api/topology');
        const topo = await res.json();

        const groups = {
            vcenter:          { color: { background: '#0078d4', border: '#005a9e' }, shape: 'diamond', size: 30, font: { color: '#fff', size: 14, bold: true } },
            datacenter:       { color: { background: '#ffd700', border: '#b8960f' }, shape: 'box', size: 25, font: { color: '#000', size: 13, bold: true } },
            host:             { color: { background: '#9966ff', border: '#7744dd' }, shape: 'box', size: 20, font: { color: '#fff', size: 12 } },
            fileshare_folder: { color: { background: '#f59e0b', border: '#d97706' }, shape: 'box', size: 18, font: { color: '#000', size: 12 } },
            network_folder:   { color: { background: '#06b6d4', border: '#0891b2' }, shape: 'box', size: 18, font: { color: '#000', size: 12 } },
            fileshare:        { color: { background: '#f59e0b', border: '#d97706' }, shape: 'dot', size: 12, font: { color: '#e6edf3', size: 10 } },
            network:          { color: { background: '#06b6d4', border: '#0891b2' }, shape: 'dot', size: 12, font: { color: '#e6edf3', size: 10 } },
            vm_on:            { color: { background: '#10b981', border: '#059669' }, shape: 'dot', size: 8, font: { color: '#e6edf3', size: 9 } },
            vm_off:           { color: { background: '#ef4444', border: '#dc2626' }, shape: 'dot', size: 6, font: { color: '#8b949e', size: 8 } },
        };

        const container = document.getElementById('topology-container');
        const data = {
            nodes: new vis.DataSet(topo.nodes),
            edges: new vis.DataSet(topo.edges)
        };

        topologyNetwork = new vis.Network(container, data, {
            groups: groups,
            layout: {
                hierarchical: {
                    enabled: true,
                    direction: 'UD',
                    sortMethod: 'hubsize',
                    levelSeparation: 100,
                    nodeSpacing: 20,
                    treeSpacing: 40,
                }
            },
            physics: {
                enabled: true,
                hierarchicalRepulsion: { nodeDistance: 120, centralGravity: 0.1 },
                stabilization: { iterations: 200 }
            },
            interaction: { hover: true, tooltipDelay: 100, navigationButtons: true, keyboard: true },
            edges: { color: { color: '#30363d', hover: '#58a6ff' }, width: 1, smooth: { type: 'cubicBezier' } }
        });

        topologyNetwork.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = topo.nodes.find(n => n.id === nodeId);
                if (node) {
                    const panel = document.getElementById('topo-detail-panel');
                    const content = document.getElementById('topo-detail-content');
                    content.innerHTML = `<pre style="color:#e6edf3; white-space:pre-wrap; margin:0">${node.title}</pre>`;
                    panel.style.display = 'block';
                }
            }
        });
    }

    function topologyFit() {
        if (topologyNetwork) topologyNetwork.fit({ animation: true });
    }

    function togglePhysics() {
        physicsEnabled = !physicsEnabled;
        if (topologyNetwork) topologyNetwork.setOptions({ physics: { enabled: physicsEnabled } });
    }

    // ================================================================
    // ASSESSMENT ENGINE
    // ================================================================
    async function loadAssessment() {
        const res = await fetch('/api/vms');
        allVMs = await res.json();
        renderAssessmentTable();

        document.getElementById('assess-search').addEventListener('input', renderAssessmentTable);
        document.getElementById('assess-readiness-filter').addEventListener('change', renderAssessmentTable);
        document.getElementById('assess-os-filter').addEventListener('change', renderAssessmentTable);
        document.getElementById('assess-power-filter').addEventListener('change', renderAssessmentTable);
    }

    function sortAssessment(col) {
        if (assessmentSort.col === col) {
            assessmentSort.asc = !assessmentSort.asc;
        } else {
            assessmentSort.col = col;
            assessmentSort.asc = true;
        }
        renderAssessmentTable();
    }

    function renderAssessmentTable() {
        const search = document.getElementById('assess-search').value.toLowerCase();
        const readFilter = document.getElementById('assess-readiness-filter').value;
        const osFilter = document.getElementById('assess-os-filter').value;
        const powerFilter = document.getElementById('assess-power-filter').value;

        let filtered = allVMs.filter(vm => {
            const rec = vm.recommendation || {};
            const text = [vm.name, vm.guest_os, vm.host, rec.recommended_vm_sku || ''].join(' ').toLowerCase();
            if (search && !text.includes(search)) return false;
            if (readFilter && rec.migration_readiness !== readFilter) return false;
            if (osFilter && vm.guest_os_family !== osFilter) return false;
            if (powerFilter && vm.power_state !== powerFilter) return false;
            return true;
        });

        // Sort
        const col = assessmentSort.col;
        const dir = assessmentSort.asc ? 1 : -1;
        filtered.sort((a, b) => {
            let va, vb;
            switch(col) {
                case 'name': va = a.name; vb = b.name; return va.localeCompare(vb) * dir;
                case 'cpu': va = a.num_cpus; vb = b.num_cpus; break;
                case 'mem': va = a.memory_mb; vb = b.memory_mb; break;
                case 'disk': va = a.total_disk_gb; vb = b.total_disk_gb; break;
                case 'cost': va = (a.recommendation||{}).estimated_monthly_cost_usd||0;
                             vb = (b.recommendation||{}).estimated_monthly_cost_usd||0; break;
                case 'confidence': va = (a.recommendation||{}).confidence_score||0;
                                   vb = (b.recommendation||{}).confidence_score||0; break;
                default: va = a.name; vb = b.name; return va.localeCompare(vb) * dir;
            }
            return (va - vb) * dir;
        });

        document.getElementById('assess-count').textContent = filtered.length + ' VMs';

        const tbody = document.getElementById('assess-tbody');
        tbody.innerHTML = filtered.map(vm => {
            const r = vm.recommendation || {};
            const powerBadge = vm.power_state === 'poweredOn'
                ? '<span class="badge bg-success">ON</span>'
                : '<span class="badge bg-danger">OFF</span>';
            const osBadge = vm.guest_os_family === 'windows'
                ? '<span class="badge" style="background:#0078d4">Win</span>'
                : '<span class="badge" style="background:#f97316">Linux</span>';

            let readBadge = '';
            switch(r.migration_readiness) {
                case 'Ready': readBadge = '<span class="badge badge-ready">Ready</span>'; break;
                case 'Ready with conditions': readBadge = '<span class="badge badge-conditional">Conditional</span>'; break;
                case 'Not Ready': readBadge = '<span class="badge badge-not-ready">Not Ready</span>'; break;
                default: readBadge = '<span class="badge bg-secondary">Unknown</span>';
            }

            const conf = r.confidence_score || 0;
            const confColor = conf >= 80 ? '#10b981' : conf >= 50 ? '#f59e0b' : '#ef4444';
            const boostBadge = r.enrichment_boost ? `<i class="bi bi-arrow-up-circle-fill" style="color:#10b981;font-size:0.65rem" title="Enriched +${r.enrichment_boost}% from ${r.enrichment_tool||'monitoring'}"></i>` : '';
            const confBar = `<div class="d-flex align-items-center gap-2">
                <div style="width:50px;height:6px;background:#21262d;border-radius:3px;overflow:hidden">
                    <div style="width:${conf}%;height:100%;background:${confColor};border-radius:3px"></div>
                </div>
                <small style="color:${confColor}">${conf.toFixed(0)}%</small>${boostBadge}
            </div>`;

            const issues = (r.migration_issues || []).map(i => `<small class="text-warning">â€¢ ${i}</small>`).join('<br>');

            return `<tr style="cursor:pointer" onclick="openWhatIf('${vm.name.replace(/'/g, "\\'")}')"
                    title="Click for What-If Analysis">
                <td title="${vm.name}"><strong>${vm.name.substring(0,25)}</strong><br><small class="text-muted">${vm.host}</small></td>
                <td>${powerBadge}</td>
                <td>${osBadge}</td>
                <td>${vm.num_cpus}</td>
                <td>${Math.round(vm.memory_mb/1024)}</td>
                <td>${Math.round(vm.total_disk_gb)}</td>
                <td><code>${r.recommended_vm_sku||'â€”'}</code><br><small class="text-muted">${r.recommended_vm_family||''}</small></td>
                <td>${r.recommended_disk_type||'â€”'}</td>
                <td><strong>$${(r.estimated_monthly_cost_usd||0).toFixed(2)}</strong></td>
                <td>${readBadge}</td>
                <td>${confBar}</td>
                <td>${issues || '<span class="text-success">âœ“</span>'}</td>
            </tr>`;
        }).join('');
    }

    // ================================================================
    // SIMULATION ENGINE
    // ================================================================

    async function loadWhatIfComparison() {
        try {
            const res = await fetch('/api/simulate_comparison', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const cmp = await res.json();
            if (cmp.error || cmp.total_overrides === 0) {
                document.getElementById('sim-whatif-comparison').style.display = 'none';
                return;
            }
            document.getElementById('sim-whatif-comparison').style.display = 'block';
            document.getElementById('sim-override-count').textContent = cmp.total_overrides + ' override' + (cmp.total_overrides !== 1 ? 's' : '');
            document.getElementById('cmp-fleet-original').textContent = '$' + cmp.fleet_original_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('cmp-fleet-adjusted').textContent = '$' + cmp.fleet_adjusted_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
            const fleetSavingsEl = document.getElementById('cmp-fleet-savings');
            fleetSavingsEl.textContent = '$' + cmp.fleet_savings_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
            fleetSavingsEl.className = cmp.fleet_savings_monthly >= 0 ? 'cost-savings' : 'cost-increase';
            document.getElementById('cmp-fleet-savings-pct').textContent = cmp.fleet_savings_pct + '% savings';
            document.getElementById('cmp-override-savings').textContent = '$' + cmp.overridden_savings_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById('cmp-override-detail').textContent = cmp.total_overrides + ' VMs: $' + cmp.overridden_original_monthly.toFixed(2) + ' â†’ $' + cmp.overridden_whatif_monthly.toFixed(2);

            const tbody = document.getElementById('cmp-tbody');
            tbody.innerHTML = cmp.comparisons.map(c => {
                const deltaClass = c.delta >= 0 ? 'cost-savings' : 'cost-increase';
                const deltaSign = c.delta >= 0 ? '-' : '+';
                return `<tr>
                    <td><strong>${c.vm_name.substring(0,25)}</strong></td>
                    <td><code>${c.original_sku}</code></td>
                    <td>$${c.original_cost.toFixed(2)}</td>
                    <td><i class="bi bi-arrow-right"></i></td>
                    <td><code>${c.whatif_sku}</code></td>
                    <td>${c.whatif_region}</td>
                    <td>${c.whatif_pricing.replace(/_/g, ' ')}</td>
                    <td>$${c.whatif_cost.toFixed(2)}</td>
                    <td class="${deltaClass}">${deltaSign}$${Math.abs(c.delta).toFixed(2)}</td>
                </tr>`;
            }).join('');
        } catch(e) {
            console.error('Failed to load what-if comparison', e);
            document.getElementById('sim-whatif-comparison').style.display = 'none';
        }
    }

    async function clearAllOverrides() {
        try {
            await fetch('/api/whatif_overrides', { method: 'DELETE' });
            whatIfOverridesCache = {};
            document.getElementById('sim-whatif-comparison').style.display = 'none';
        } catch(e) { console.error('Failed to clear overrides', e); }
    }

    document.getElementById('sim-waves').addEventListener('input', function() {
        document.getElementById('sim-waves-val').textContent = this.value;
    });

    async function runSimulation() {
        const region = document.getElementById('sim-region').value;
        const pricing = document.getElementById('sim-pricing').value;
        const waves = parseInt(document.getElementById('sim-waves').value);
        const vmFilter = document.getElementById('sim-vm-filter').value;

        // Build selected VMs list
        let selected = 'all';
        if (vmFilter !== 'all') {
            const res = await fetch('/api/vms');
            const vms = await res.json();
            let filtered;
            switch(vmFilter) {
                case 'powered_on': filtered = vms.filter(v => v.power_state === 'poweredOn'); break;
                case 'ready': filtered = vms.filter(v => (v.recommendation||{}).migration_readiness === 'Ready'); break;
                case 'windows': filtered = vms.filter(v => v.guest_os_family === 'windows'); break;
                case 'linux': filtered = vms.filter(v => v.guest_os_family === 'linux'); break;
                default: filtered = vms;
            }
            selected = filtered.map(v => v.name);
        }

        // Run simulation + load comparison in parallel
        const [simRes, _cmp] = await Promise.all([
            fetch('/api/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    selected_vms: selected,
                    target_region: region,
                    pricing_model: pricing,
                    waves: waves
                })
            }),
            loadWhatIfComparison()
        ]);
        const sim = await simRes.json();

        // Show results
        document.getElementById('sim-placeholder').style.display = 'none';
        document.getElementById('sim-results').style.display = 'block';
        document.getElementById('sim-cost-card').style.display = 'block';

        // Cost card
        document.getElementById('sim-original-cost').textContent = '$' + sim.total_original_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('sim-new-cost').textContent = '$' + sim.total_simulated_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        const savingsEl = document.getElementById('sim-savings-monthly');
        savingsEl.textContent = '$' + sim.total_savings_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        savingsEl.className = 'fw-bold ' + (sim.total_savings_monthly >= 0 ? 'cost-savings' : 'cost-increase');
        document.getElementById('sim-savings-annual').textContent = '$' + sim.total_savings_annual.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('sim-savings-pct').textContent = sim.savings_percent + '%';

        // Projection chart
        if (projectionChart) projectionChart.destroy();
        const proj = sim.monthly_projection;
        projectionChart = new Chart(document.getElementById('chart-sim-projection'), {
            type: 'line',
            data: {
                labels: proj.map(p => 'Month ' + p.month),
                datasets: [
                    {
                        label: 'Azure Monthly Cost ($)',
                        data: proj.map(p => p.azure_cost),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0,120,212,0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4
                    },
                    {
                        label: 'VMs on Azure',
                        data: proj.map(p => p.vms_on_azure),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        tension: 0.3,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8b949e' } } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() }, grid: { color: '#21262d' }, title: { display: true, text: 'Monthly Cost', color: '#8b949e' } },
                    y1: { position: 'right', ticks: { color: '#10b981' }, grid: { display: false }, title: { display: true, text: 'VMs Migrated', color: '#10b981' } }
                }
            }
        });

        // Wave cards â€” draggable
        _vmSimData = sim;  // store globally for drag-drop recalc
        renderVmWaveCards(sim);

        // Build wave lookup
        _vmWaveMap = {};
        sim.wave_details.forEach(w => {
            w.vms.forEach(v => { _vmWaveMap[v.vm_name] = w.wave; });
        });

        // Simulation detail table
        const simTbody = document.getElementById('sim-tbody');
        _renderVmSimTable = (searchTerm) => {
            let details = _vmSimData.vm_details;
            if (searchTerm) {
                details = details.filter(v => v.vm_name.toLowerCase().includes(searchTerm));
            }
            simTbody.innerHTML = details.map(v => {
                const savingsClass = v.savings >= 0 ? 'cost-savings' : 'cost-increase';
                let readBadge;
                switch(v.readiness) {
                    case 'Ready': readBadge = '<span class="badge badge-ready">Ready</span>'; break;
                    case 'Ready with conditions': readBadge = '<span class="badge badge-conditional">Cond.</span>'; break;
                    default: readBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                return `<tr>
                    <td><strong>${v.vm_name.substring(0,25)}</strong></td>
                    <td><code>${v.original_sku}</code></td>
                    <td><code>${v.simulated_sku}</code></td>
                    <td>$${v.original_cost.toFixed(2)}</td>
                    <td>$${v.simulated_cost.toFixed(2)}</td>
                    <td class="${savingsClass}">$${v.savings.toFixed(2)}</td>
                    <td>${readBadge}</td>
                    <td><span class="badge" style="background:var(--azure-blue)">Wave ${_vmWaveMap[v.vm_name]||'?'}</span></td>
                </tr>`;
            }).join('');
        };
        _renderVmSimTable('');
        document.getElementById('sim-search').addEventListener('input', e => _renderVmSimTable(e.target.value.toLowerCase()));
    }

    // ================================================================
    // VM WAVE DRAG-AND-DROP
    // ================================================================
    let _vmSimData = null;
    let _vmWaveMap = {};
    let _renderVmSimTable = null;

    function renderVmWaveCards(sim) {
        const wavesContainer = document.getElementById('sim-waves-container');
        wavesContainer.innerHTML = sim.wave_details.map((w, wi) => {
            const readyCount = w.vms.filter(v => v.readiness === 'Ready').length;
            const condCount = w.vms.filter(v => v.readiness === 'Ready with conditions').length;
            const winCount = w.vms.filter(v => v.os_family === 'windows').length;
            const linCount = w.vms.length - winCount;
            return `<div class="wave-card fade-in" data-wave="${w.wave}"
                         ondragover="vmWaveDragOver(event)" ondragleave="vmWaveDragLeave(event)" ondrop="vmWaveDrop(event, ${w.wave})">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="wave-num">Wave ${w.wave}</span>
                        <span class="badge bg-secondary ms-2 vm-wave-count" data-wave="${w.wave}">${w.vm_count} VMs</span>
                    </div>
                    <div class="fw-bold vm-wave-cost" data-wave="${w.wave}" style="color:var(--azure-light)">$${w.cost.toLocaleString(undefined,{minimumFractionDigits:2})}/mo</div>
                </div>
                <div class="d-flex gap-3 mb-2 small text-muted">
                    <span><span class="badge badge-ready">Ready: ${readyCount}</span></span>
                    <span><span class="badge badge-conditional">Conditional: ${condCount}</span></span>
                    <span><i class="bi bi-windows" style="color:#0078d4"></i> ${winCount}</span>
                    <span><i class="bi bi-ubuntu" style="color:#f97316"></i> ${linCount}</span>
                </div>
                <div class="wave-dropzone small text-muted" style="max-height:80px;overflow-y:auto" data-wave="${w.wave}">
                    ${w.vms.map(v => `<span class="badge bg-dark border border-secondary me-1 mb-1 wave-item"
                        draggable="true" data-vm="${v.vm_name}" data-wave="${w.wave}"
                        ondragstart="vmWaveDragStart(event)" ondragend="vmWaveDragEnd(event)"
                        title="Drag to move to another wave">${v.vm_name.substring(0,20)}</span>`).join('')}
                </div>
                <div class="wave-hint"><i class="bi bi-arrows-move me-1"></i>Drag VMs between waves to re-plan</div>
            </div>`;
        }).join('');
    }

    let _vmDragItem = null;
    function vmWaveDragStart(e) {
        _vmDragItem = { vmName: e.target.dataset.vm, fromWave: parseInt(e.target.dataset.wave) };
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.target.dataset.vm);
        requestAnimationFrame(() => e.target.classList.add('dragging'));
    }
    function vmWaveDragEnd(e) { e.target.classList.remove('dragging'); }
    function vmWaveDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
    function vmWaveDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
    function vmWaveDrop(e, toWave) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!_vmDragItem) return;
        const { vmName, fromWave } = _vmDragItem;
        _vmDragItem = null;
        if (fromWave === toWave) return;

        // Move VM between waves in sim data
        const sim = _vmSimData;
        const srcWave = sim.wave_details.find(w => w.wave === fromWave);
        const dstWave = sim.wave_details.find(w => w.wave === toWave);
        if (!srcWave || !dstWave) return;

        const vmIdx = srcWave.vms.findIndex(v => v.vm_name === vmName);
        if (vmIdx === -1) return;

        const [vmObj] = srcWave.vms.splice(vmIdx, 1);
        dstWave.vms.push(vmObj);

        // Recalculate wave stats
        sim.wave_details.forEach(w => {
            w.vm_count = w.vms.length;
            w.cost = Math.round(w.vms.reduce((s, v) => s + v.simulated_cost, 0) * 100) / 100;
        });

        // Recalculate monthly projection
        let cumulative = 0, vmsMigrated = 0;
        sim.monthly_projection = [];
        for (let i = 0; i < 12; i++) {
            if (i < sim.wave_details.length) {
                const waveVms = sim.wave_details[i].vms;
                vmsMigrated += waveVms.length;
                cumulative += waveVms.reduce((s, v) => s + v.simulated_cost, 0);
            }
            sim.monthly_projection.push({
                month: i + 1,
                azure_cost: Math.round(cumulative * 100) / 100,
                vms_on_azure: vmsMigrated,
                vms_on_prem: sim.total_vms - vmsMigrated,
            });
        }

        // Rebuild wave map
        _vmWaveMap = {};
        sim.wave_details.forEach(w => { w.vms.forEach(v => { _vmWaveMap[v.vm_name] = w.wave; }); });

        // Re-render
        renderVmWaveCards(sim);
        if (_renderVmSimTable) _renderVmSimTable(document.getElementById('sim-search').value.toLowerCase());

        // Re-render projection chart
        if (projectionChart) projectionChart.destroy();
        const proj = sim.monthly_projection;
        projectionChart = new Chart(document.getElementById('chart-sim-projection'), {
            type: 'line',
            data: {
                labels: proj.map(p => 'Month ' + p.month),
                datasets: [
                    { label: 'Azure Monthly Cost ($)', data: proj.map(p => p.azure_cost), borderColor: '#0078d4', backgroundColor: 'rgba(0,120,212,0.1)', fill: true, tension: 0.3, pointRadius: 4 },
                    { label: 'VMs on Azure', data: proj.map(p => p.vms_on_azure), borderColor: '#10b981', borderDash: [5,5], tension: 0.3, pointRadius: 4, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8b949e' } } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { color: '#8b949e', callback: v => '$'+v.toLocaleString() }, grid: { color: '#21262d' }, title: { display: true, text: 'Monthly Cost', color: '#8b949e' } },
                    y1: { position: 'right', ticks: { color: '#10b981' }, grid: { display: false }, title: { display: true, text: 'VMs Migrated', color: '#10b981' } }
                }
            }
        });
    }

    // ================================================================
    // VM WHAT-IF ANALYSIS
    // ================================================================
    let whatIfData = null;
    let whatIfSelectedSku = null;
    let whatIfPricingChart = null;
    let whatIfCurrentVmName = null;
    let whatIfOverridesCache = {};

    async function loadWhatIfOverrides() {
        try {
            const res = await fetch('/api/whatif_overrides');
            whatIfOverridesCache = await res.json();
        } catch(e) { whatIfOverridesCache = {}; }
    }

    function updateWhatIfSavedIndicator() {
        const saved = whatIfOverridesCache[whatIfCurrentVmName];
        const savedBadge = document.getElementById('whatif-saved-badge');
        const unsavedBadge = document.getElementById('whatif-unsaved-badge');
        const removeBtn = document.getElementById('whatif-remove-btn');
        if (saved) {
            savedBadge.style.display = '';
            unsavedBadge.style.display = 'none';
            removeBtn.style.display = '';
            document.getElementById('whatif-saved-info').textContent = saved.sku + ' Â· ' + saved.region + ' Â· ' + saved.pricing.replace(/_/g, ' ');
        } else {
            savedBadge.style.display = 'none';
            unsavedBadge.style.display = '';
            removeBtn.style.display = 'none';
        }
    }

    async function saveWhatIfPreference() {
        if (!whatIfCurrentVmName || !whatIfSelectedSku) return;
        const region = document.getElementById('whatif-region').value;
        const pricing = document.getElementById('whatif-pricing').value;
        try {
            const res = await fetch('/api/whatif_overrides', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vm_name: whatIfCurrentVmName,
                    sku: whatIfSelectedSku,
                    region: region,
                    pricing: pricing
                })
            });
            const result = await res.json();
            if (result.status === 'saved') {
                whatIfOverridesCache[whatIfCurrentVmName] = { sku: whatIfSelectedSku, region, pricing };
                updateWhatIfSavedIndicator();
            }
        } catch(e) { console.error('Failed to save preference', e); }
    }

    async function removeWhatIfPreference() {
        if (!whatIfCurrentVmName) return;
        try {
            await fetch('/api/whatif_overrides/' + encodeURIComponent(whatIfCurrentVmName), { method: 'DELETE' });
            delete whatIfOverridesCache[whatIfCurrentVmName];
            updateWhatIfSavedIndicator();
        } catch(e) { console.error('Failed to remove preference', e); }
    }

    async function openWhatIf(vmName) {
        whatIfCurrentVmName = vmName;
        document.getElementById('whatif-vm-name').textContent = vmName;
        document.getElementById('vm-whatif-backdrop').classList.add('show');
        document.body.style.overflow = 'hidden';

        // Reset
        document.getElementById('whatif-details').innerHTML = '<div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> Loading...</div>';
        document.getElementById('whatif-sku-grid').innerHTML = '';

        // Load overrides + VM data in parallel
        const [_, simRes] = await Promise.all([
            loadWhatIfOverrides(),
            fetch('/api/simulate_vm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vm_name: vmName })
            })
        ]);
        whatIfData = await simRes.json();
        if (whatIfData.error) { closeWhatIf(); return; }

        const vm = whatIfData.vm;
        const rec = whatIfData.current_recommendation;

        // VM detail grid â€” use perf history stats if available, fallback to snapshot
        const perf = vm.perf || {};
        const ps = whatIfData.perf_stats || {};
        const cpuStat = ps.cpu || {};
        const memStat = ps.mem || {};
        const iopsStat = ps.disk_iops || {};

        function _perfVal(stat, snapshotVal, unit) {
            if (stat && stat.count > 0) {
                return `<span title="avg / p95 / max over ${stat.count} samples">${stat.avg.toFixed(1)}${unit} <span class="text-muted small">(p95: ${stat.p95.toFixed(1)}${unit})</span></span>`;
            }
            return snapshotVal > 0 ? snapshotVal.toFixed(1) + unit : 'N/A';
        }

        const details = [
            { label: 'Power State', value: vm.power_state === 'poweredOn' ? 'ðŸŸ¢ Powered On' : 'ðŸ”´ Powered Off' },
            { label: 'vCPUs', value: vm.num_cpus },
            { label: 'Memory', value: vm.memory_gb + ' GB' },
            { label: 'Total Disk', value: Math.round(vm.total_disk_gb) + ' GB' },
            { label: 'OS', value: vm.guest_os },
            { label: 'Host', value: vm.host },
            { label: 'Datacenter', value: vm.datacenter },
            { label: 'Folder', value: vm.folder || 'â€”' },
            { label: 'VMware Tools', value: vm.tools_status || 'â€”' },
            { label: 'CPU Usage', value: _perfVal(cpuStat, perf.cpu_usage_percent, '%') },
            { label: 'Memory Usage', value: _perfVal(memStat, perf.memory_usage_percent, '%') },
            { label: 'Disk IOPS', value: _perfVal(iopsStat, (perf.disk_iops_read||0)+(perf.disk_iops_write||0), '') },
        ];
        document.getElementById('whatif-details').innerHTML = details.map(d =>
            `<div class="vm-detail-item"><div class="label">${d.label}</div><div class="value">${d.value}</div></div>`
        ).join('');

        // Load perf sparklines
        loadPerfSparklines(vmName, whatIfData);

        // Disks & NICs
        let infraHtml = '';
        if (vm.disks && vm.disks.length) {
            infraHtml += `<div class="col-md-6"><div class="card-dark"><div class="card-header py-2"><i class="bi bi-hdd me-1"></i>Disks (${vm.disks.length})</div>
                <div class="card-body p-2"><table class="table table-sm table-dark-custom mb-0"><thead><tr><th>Label</th><th>Size</th><th>Thin</th><th>File Share</th></tr></thead><tbody>`;
            vm.disks.forEach(d => {
                infraHtml += `<tr><td>${d.label}</td><td>${d.capacity_gb} GB</td><td>${d.thin_provisioned ? 'Yes' : 'No'}</td><td>${d.datastore_name}</td></tr>`;
            });
            infraHtml += '</tbody></table></div></div></div>';
        }
        if (vm.nics && vm.nics.length) {
            infraHtml += `<div class="col-md-6"><div class="card-dark"><div class="card-header py-2"><i class="bi bi-ethernet me-1"></i>NICs (${vm.nics.length})</div>
                <div class="card-body p-2"><table class="table table-sm table-dark-custom mb-0"><thead><tr><th>Name</th><th>MAC</th><th>Network</th><th>IPs</th></tr></thead><tbody>`;
            vm.nics.forEach(n => {
                infraHtml += `<tr><td>${n.name}</td><td><code>${n.mac_address}</code></td><td>${n.network_name}</td><td>${(n.ip_addresses||[]).join(', ')||'â€”'}</td></tr>`;
            });
            infraHtml += '</tbody></table></div></div></div>';
        }
        document.getElementById('whatif-infra-row').innerHTML = infraHtml;

        // Set current recommendation info
        document.getElementById('whatif-current-cost').textContent = '$' + rec.estimated_monthly_cost_usd.toFixed(2) + '/mo';
        document.getElementById('whatif-current-sku').textContent = rec.recommended_vm_sku + ' + ' + rec.recommended_disk_type;

        // Restore saved preference if exists, otherwise use current recommendation
        const savedOv = whatIfOverridesCache[vmName];
        if (savedOv) {
            whatIfSelectedSku = savedOv.sku;
            document.getElementById('whatif-region').value = savedOv.region || 'eastus';
            document.getElementById('whatif-pricing').value = savedOv.pricing || 'pay_as_you_go';
        } else {
            whatIfSelectedSku = rec.recommended_vm_sku;
        }
        updateWhatIfSavedIndicator();
        renderSkuGrid();
        recalcWhatIf();
    }

    function closeWhatIf() {
        document.getElementById('vm-whatif-backdrop').classList.remove('show');
        document.body.style.overflow = '';
        if (whatIfPricingChart) { whatIfPricingChart.destroy(); whatIfPricingChart = null; }
        _perfSparkCharts.forEach(c => { try { c.destroy(); } catch(e) {} });
        _perfSparkCharts = [];
    }

    function renderSkuGrid() {
        if (!whatIfData) return;
        const showUnfit = document.getElementById('whatif-show-unfit').checked;
        const region = document.getElementById('whatif-region').value;
        const pricing = document.getElementById('whatif-pricing').value;

        let skus = whatIfData.sku_comparisons;
        if (!showUnfit) skus = skus.filter(s => s.fits_vm);

        // Find max cost for bar scaling
        const maxCost = Math.max(...skus.map(s => s.region_costs[region][pricing]));

        const grid = document.getElementById('whatif-sku-grid');
        grid.innerHTML = skus.map(s => {
            const cost = s.region_costs[region][pricing];
            const pct = maxCost > 0 ? (cost / maxCost * 100) : 0;
            const isSelected = s.sku === whatIfSelectedSku;
            const isCurrent = s.is_current;
            let cls = 'sku-option';
            if (isSelected) cls += ' selected';
            if (isCurrent && !isSelected) cls += ' current-rec';
            if (!s.fits_vm) cls += ' doesnt-fit';

            const barColor = isCurrent ? '#10b981' : (isSelected ? '#0078d4' : '#30363d');

            return `<div class="${cls}" onclick="selectSku('${s.sku}')">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong style="font-size:0.85rem">${s.sku}</strong>
                    ${isCurrent ? '<span class="badge badge-ready" style="font-size:0.65rem">REC</span>' : ''}
                    ${!s.fits_vm ? '<span class="badge bg-danger" style="font-size:0.6rem">UNDERSIZE</span>' : ''}
                </div>
                <div class="small text-muted mb-1">${s.vcpus} vCPU Â· ${s.memory_gb} GB RAM</div>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span style="color:var(--azure-light);font-weight:700">$${cost.toFixed(2)}/mo</span>
                    <span class="small text-muted">$${(cost*12).toFixed(0)}/yr</span>
                </div>
                <div style="background:#21262d;height:6px;border-radius:3px;overflow:hidden">
                    <div class="compare-bar" style="width:${pct}%;background:${barColor}"></div>
                </div>
            </div>`;
        }).join('');
    }

    function selectSku(skuName) {
        whatIfSelectedSku = skuName;
        renderSkuGrid();
        recalcWhatIf();
    }

    function recalcWhatIf() {
        if (!whatIfData || !whatIfSelectedSku) return;
        const region = document.getElementById('whatif-region').value;
        const pricing = document.getElementById('whatif-pricing').value;
        const rec = whatIfData.current_recommendation;

        const selected = whatIfData.sku_comparisons.find(s => s.sku === whatIfSelectedSku);
        if (!selected) return;

        const selectedCost = selected.region_costs[region][pricing];
        const currentCost = rec.estimated_monthly_cost_usd;
        const delta = currentCost - selectedCost;

        document.getElementById('whatif-selected-cost').textContent = '$' + selectedCost.toFixed(2) + '/mo';
        document.getElementById('whatif-selected-sku').textContent = whatIfSelectedSku + ' Â· ' + region + ' Â· ' + pricing.replace(/_/g,' ');

        const deltaEl = document.getElementById('whatif-delta');
        if (delta >= 0) {
            deltaEl.innerHTML = `<span class="cost-savings">Save $${delta.toFixed(2)}/mo</span>`;
        } else {
            deltaEl.innerHTML = `<span class="cost-increase">+$${Math.abs(delta).toFixed(2)}/mo</span>`;
        }
        document.getElementById('whatif-delta-annual').textContent = (delta >= 0 ? 'Save' : 'Extra') + ' $' + Math.abs(delta * 12).toFixed(2) + '/year';

        renderSkuGrid();

        // Pricing comparison chart for selected SKU
        const pricingLabels = Object.keys(whatIfData.pricing_models);
        const pricingCosts = pricingLabels.map(p => selected.region_costs[region][p]);
        const pricingColors = pricingLabels.map(p => p === pricing ? '#0078d4' : '#30363d');

        if (whatIfPricingChart) whatIfPricingChart.destroy();
        whatIfPricingChart = new Chart(document.getElementById('chart-whatif-pricing'), {
            type: 'bar',
            data: {
                labels: pricingLabels.map(p => p.replace(/_/g, ' ')),
                datasets: [{
                    label: 'Monthly Cost',
                    data: pricingCosts,
                    backgroundColor: pricingColors,
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => '$' + ctx.parsed.y.toFixed(2) + '/mo' } }
                },
                scales: {
                    x: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { color: '#8b949e', callback: v => '$'+v }, grid: { color: '#21262d' } }
                }
            }
        });
    }

    // Close on Escape
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeWhatIf(); });

    // ================================================================
    // TAB SWITCHING â€” sub-tabs inside Discovery & Assessment pane
    // ================================================================
    document.getElementById('subtab-topology').addEventListener('shown.bs.tab', () => {
        if (!topoNetwork) loadTopology();
        if (wlData && !wlTopoNetwork) loadWorkloadTopology();
    });
    document.getElementById('subtab-assessment').addEventListener('shown.bs.tab', () => { if(!allVMs.length) loadAssessment(); });
    document.getElementById('subtab-simulation').addEventListener('shown.bs.tab', () => { setTimeout(renderWlSimCharts, 200); });
    // When "Discovery & Assessment" top-level tab is shown, load inventory (default sub-tab)
    document.getElementById('tab-workloads').addEventListener('shown.bs.tab', () => {
        // Inventory is default sub-tab, no special load needed
    });

    // ================================================================
    // WORKLOAD DISCOVERY
    // ================================================================
    let wlData = null;
    let wlTopoNetwork = null;
    let wlInventoryRows = [];
    let infraInventoryRows = [];  // network + file share rows from vCenter
    let wlAssessRows = [];
    let wlWhatIfOverridesCache = {};
    let wlWhatIfData = null;         // current modal data
    let wlWhatIfSelectedSvc = null;  // currently selected service name
    let wlWhatIfChart = null;        // chart instance

    async function loadInfraInventory() {
        // Fetch networks and file shares from vCenter discovery
        try {
            const [netRes, fsRes, vmRes] = await Promise.all([
                fetch('/api/networks'), fetch('/api/fileshares'), fetch('/api/vms')
            ]);
            const networks = await netRes.json();
            const fileshares = await fsRes.json();
            const vms = await vmRes.json();

            // Build VM-to-network mapping
            const netVmMap = {};
            for (const vm of vms) {
                for (const nic of (vm.nics || [])) {
                    const nn = nic.network_name || '';
                    if (!nn) continue;
                    if (!netVmMap[nn]) netVmMap[nn] = [];
                    netVmMap[nn].push(vm.name);
                }
            }
            // Build VM-to-file-share mapping (from disk info)
            const fsVmMap = {};
            for (const vm of vms) {
                for (const disk of (vm.disks || [])) {
                    const dn = disk.datastore_name || '';
                    if (!dn) continue;
                    if (!fsVmMap[dn]) fsVmMap[dn] = [];
                    if (!fsVmMap[dn].includes(vm.name)) fsVmMap[dn].push(vm.name);
                }
            }

            infraInventoryRows = [];
            for (const net of networks) {
                const connVMs = netVmMap[net.name] || [];
                infraInventoryRows.push({
                    vm: connVMs.length ? connVMs.slice(0,3).join(', ') + (connVMs.length > 3 ? 'â€¦' : '') : 'â€”',
                    type: 'Network',
                    typeIcon: 'bi-hdd-network',
                    typeColor: '#e879f9',
                    workload: net.name,
                    version: net.network_type || 'â€”',
                    port: net.vlan_id ? `VLAN ${net.vlan_id}` : 'â€”',
                    details: `Datacenter: ${net.datacenter || '?'} | Connected VMs: ${connVMs.length}`,
                    azureTarget: 'Azure Virtual Network / NSG',
                });
            }
            for (const fs of fileshares) {
                const usedGB = Math.round((fs.capacity_gb || 0) - (fs.free_space_gb || 0));
                const connVMs = fsVmMap[fs.name] || [];
                infraInventoryRows.push({
                    vm: connVMs.length ? connVMs.slice(0,3).join(', ') + (connVMs.length > 3 ? 'â€¦' : '') : 'â€”',
                    type: 'File Share',
                    typeIcon: 'bi-folder-symlink',
                    typeColor: '#fb923c',
                    workload: fs.name,
                    version: fs.share_type || fs.type || 'â€”',
                    port: fs.protocol || 'â€”',
                    details: `Capacity: ${Math.round(fs.capacity_gb||0)} GB | Used: ${usedGB} GB | Free: ${Math.round(fs.free_space_gb||0)} GB | DC: ${fs.datacenter||'?'}`,
                    azureTarget: (fs.share_type||fs.type) === 'NFS' ? 'Azure NetApp Files / Azure Files' : 'Azure Managed Disks / Azure Files',
                });
            }

            // Update filter card counts
            document.getElementById('wl-card-networks').textContent = networks.length;
            document.getElementById('wl-card-fileshares').textContent = fileshares.length;

            renderWorkloadInventory();
        } catch(e) { console.error('Failed to load infra inventory', e); }
    }

    // Workers slider
    document.getElementById('wl-workers').addEventListener('input', function() {
        document.getElementById('wl-workers-val').textContent = this.value;
    });

    function parseIpMappings() {
        const raw = document.getElementById('wl-ip-map').value.trim();
        if (!raw) return {};
        const map = {};
        for (const line of raw.split('\n')) {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('#')) continue;
            const sep = trimmed.includes('=') ? '=' : trimmed.includes(',') ? ',' : trimmed.includes('\t') ? '\t' : null;
            if (!sep) continue;
            const [name, ip] = trimmed.split(sep, 2).map(s => s.trim());
            if (name && ip) map[name] = ip;
        }
        return map;
    }

    function showWlError(msg, skipped) {
        const errArea = document.getElementById('wl-error-area');
        errArea.style.display = 'block';
        document.getElementById('wl-error-msg').textContent = msg;
        if (skipped && skipped.length) {
            document.getElementById('wl-skipped-vms').innerHTML =
                '<strong>Skipped VMs (no IP):</strong><br>' + skipped.map(n => `<code>${n}</code>`).join(', ');
        } else {
            document.getElementById('wl-skipped-vms').innerHTML = '';
        }
    }

    function hideWlError() {
        document.getElementById('wl-error-area').style.display = 'none';
    }

    function addLinuxCred() {
        const container = document.getElementById('wl-linux-creds-list');
        const entry = document.createElement('div');
        entry.className = 'wl-cred-entry mb-2';
        entry.dataset.os = 'linux';
        entry.innerHTML = `<div class="row g-2 mb-1">
            <div class="col-5">
                <input type="text" class="form-control form-control-sm wl-linux-user" placeholder="Username">
            </div>
            <div class="col-3">
                <input type="password" class="form-control form-control-sm wl-linux-pass" placeholder="Password">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm wl-linux-port" value="22" placeholder="Port">
            </div>
            <div class="col-2 d-flex align-items-center">
                <button class="btn btn-sm" style="color:#ef4444;background:transparent;border:none;padding:2px 6px;" onclick="this.closest('.wl-cred-entry').remove()" title="Remove"><i class="bi bi-x-lg"></i></button>
            </div>
        </div>`;
        container.appendChild(entry);
    }

    function addWindowsCred() {
        const container = document.getElementById('wl-win-creds-list');
        const entry = document.createElement('div');
        entry.className = 'wl-cred-entry mb-2';
        entry.dataset.os = 'windows';
        entry.innerHTML = `<div class="row g-2 mb-1">
            <div class="col-5">
                <input type="text" class="form-control form-control-sm wl-win-user" placeholder="Username">
            </div>
            <div class="col-3">
                <input type="password" class="form-control form-control-sm wl-win-pass" placeholder="Password">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm wl-win-port" value="5985" placeholder="Port">
            </div>
            <div class="col-2 d-flex align-items-center">
                <button class="btn btn-sm" style="color:#ef4444;background:transparent;border:none;padding:2px 6px;" onclick="this.closest('.wl-cred-entry').remove()" title="Remove"><i class="bi bi-x-lg"></i></button>
            </div>
        </div>`;
        container.appendChild(entry);
    }

    function addDbCred() {
        const container = document.getElementById('wl-db-creds-list');
        const entry = document.createElement('div');
        entry.className = 'wl-cred-entry mb-2';
        entry.dataset.os = 'db';
        entry.innerHTML = `<div class="row g-2 mb-1">
            <div class="col-3">
                <select class="form-select form-select-sm wl-db-engine">
                    <option value="auto">Auto-detect</option>
                    <option value="mssql">SQL Server</option>
                    <option value="mysql">MySQL</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mongodb">MongoDB</option>
                    <option value="redis">Redis</option>
                    <option value="oracle">Oracle</option>
                    <option value="mariadb">MariaDB</option>
                </select>
            </div>
            <div class="col-3">
                <input type="text" class="form-control form-control-sm wl-db-user" placeholder="Username">
            </div>
            <div class="col-2">
                <input type="password" class="form-control form-control-sm wl-db-pass" placeholder="Password">
            </div>
            <div class="col-2">
                <input type="number" class="form-control form-control-sm wl-db-port" placeholder="Port">
            </div>
            <div class="col-2 d-flex align-items-center">
                <button class="btn btn-sm" style="color:#ef4444;background:transparent;border:none;padding:2px 6px;" onclick="this.closest('.wl-cred-entry').remove()" title="Remove"><i class="bi bi-x-lg"></i></button>
            </div>
        </div>`;
        container.appendChild(entry);
    }

    function collectDbCredentials() {
        const entries = document.getElementById('wl-db-creds-list').querySelectorAll('.wl-cred-entry');
        const creds = [];
        entries.forEach(entry => {
            const engine = entry.querySelector('.wl-db-engine').value;
            const user = entry.querySelector('.wl-db-user').value.trim();
            const pass = entry.querySelector('.wl-db-pass').value;
            const port = parseInt(entry.querySelector('.wl-db-port').value) || 0;
            if (user) {
                creds.push({ engine: engine, username: user, password: pass, port: port });
            }
        });
        return creds;
    }

    function collectCredentials(osType) {
        const prefix = osType === 'linux' ? 'wl-linux' : 'wl-win';
        const listId = osType === 'linux' ? 'wl-linux-creds-list' : 'wl-win-creds-list';
        const entries = document.getElementById(listId).querySelectorAll('.wl-cred-entry');
        const creds = [];
        entries.forEach(entry => {
            const user = entry.querySelector('.' + prefix + '-user').value.trim();
            const pass = entry.querySelector('.' + prefix + '-pass').value;
            const port = parseInt(entry.querySelector('.' + prefix + '-port').value) || (osType === 'linux' ? 22 : 5985);
            if (user) {
                creds.push({ username: user, password: pass, port: port });
            }
        });
        return creds;
    }

    async function startWorkloadDiscovery() {
        const linuxCreds = collectCredentials('linux');
        const winCreds   = collectCredentials('windows');
        const dbCreds    = collectDbCredentials();
        const selection = document.getElementById('wl-vm-selection').value;
        const workers   = parseInt(document.getElementById('wl-workers').value) || 5;
        const ipMappings = parseIpMappings();
        const tryDns = document.getElementById('wl-try-dns').checked;

        if (linuxCreds.length === 0 && winCreds.length === 0) {
            showWlError('Please provide at least one Linux or Windows credential.');
            return;
        }

        hideWlError();
        const btn = document.getElementById('btnWorkloadDiscover');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Resolving IPs & startingâ€¦';

        const body = {
            vm_selection: selection,
            max_workers: workers,
            ip_mappings: ipMappings,
            try_dns: tryDns,
        };
        if (linuxCreds.length > 0) { body.linux_credentials = linuxCreds; }
        if (winCreds.length > 0)   { body.windows_credentials = winCreds; }
        if (dbCreds.length > 0)    { body.database_credentials = dbCreds; }

        try {
            const res = await fetch('/api/workloads/discover', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const data = await res.json();
            if (data.error) {
                showWlError(data.error, data.skipped_vms);
                resetWlBtn();
                return;
            }

            document.getElementById('wl-progress-card').style.display = 'block';
            document.getElementById('wl-progress-msg').textContent = `Scanning ${data.targets} VMsâ€¦`;
            if (data.skipped) {
                document.getElementById('wl-progress-detail').textContent = `(${data.skipped} VMs skipped â€” no IP)`;
            }
            pollWorkloadDiscovery();
        } catch(e) {
            showWlError('Failed to start: ' + e.message);
            resetWlBtn();
        }
    }

    function resetWlBtn() {
        const btn = document.getElementById('btnWorkloadDiscover');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search me-1"></i> Discover Workloads';
    }

    function pollWorkloadDiscovery() {
        const poll = setInterval(async () => {
            try {
                const res = await fetch('/api/workloads/status');
                const st = await res.json();
                document.getElementById('wl-progress-fill').style.width = st.progress + '%';
                document.getElementById('wl-progress-msg').textContent = st.message || 'Workingâ€¦';
                const detail = st.current_vm ? `Current: ${st.current_vm} (${st.scanned||0}/${st.total||0})` : '';
                document.getElementById('wl-progress-detail').textContent = detail;

                if (st.status === 'complete') {
                    clearInterval(poll);
                    document.getElementById('wl-progress-msg').textContent = 'âœ“ ' + st.message;
                    resetWlBtn();
                    loadWorkloadResults();
                } else if (st.status === 'error') {
                    clearInterval(poll);
                    document.getElementById('wl-progress-msg').textContent = 'âš  ' + st.message;
                    document.getElementById('wl-progress-fill').style.width = '0%';
                    resetWlBtn();
                }
            } catch(e) { console.error('WL poll error', e); }
        }, 2000);
    }

    async function loadWorkloadResults() {
        try {
            const res = await fetch('/api/workloads/results');
            wlData = await res.json();
        } catch(e) { console.error('Failed to load workload results', e); return; }

        const r = wlData.result || {};
        const recs = wlData.recommendations || [];

        // Update summary
        const _crCount = (r.vm_workloads || []).reduce((s, v) => s + (v.container_runtimes || []).length, 0);
        document.getElementById('wl-sum-vms').textContent = (r.vm_workloads || []).length;
        document.getElementById('wl-sum-dbs').textContent = r.total_databases || 0;
        document.getElementById('wl-sum-webapps').textContent = r.total_webapps || 0;
        document.getElementById('wl-sum-containers').textContent = _crCount + (r.total_orchestrators || 0);
        document.getElementById('wl-sum-deps').textContent = (r.dependencies || []).length;
        document.getElementById('wl-sum-cost').textContent = '$' + (wlData.total_workload_cost || 0).toLocaleString();
        document.getElementById('wl-summary-section').style.display = 'block';
        document.getElementById('vm-summary-card').style.display = 'block';

        // Summary cards in results
        document.getElementById('wl-card-vms').textContent = (r.vm_workloads || []).length;
        document.getElementById('wl-card-dbs').textContent = r.total_databases || 0;
        document.getElementById('wl-card-webapps').textContent = r.total_webapps || 0;
        document.getElementById('wl-card-containers').textContent = _crCount + (r.total_orchestrators || 0);

        // Build inventory rows â€” VMs + all workload types
        wlInventoryRows = [];
        for (const vmw of (r.vm_workloads || [])) {
            // Add the VM itself as a row
            wlInventoryRows.push({
                vm: vmw.vm_name,
                type: 'VM',
                typeIcon: 'bi-pc-display',
                typeColor: '#0078d4',
                workload: vmw.vm_name,
                version: vmw.os_family || 'â€”',
                port: '',
                details: `Databases: ${(vmw.databases||[]).length} | Web Apps: ${(vmw.web_apps||[]).length} | Containers: ${(vmw.container_runtimes||[]).length} | Orch: ${(vmw.orchestrators||[]).length}`,
            });
            for (const db of (vmw.databases || [])) {
                const sizeInfo = db.total_size_gb ? ` | Size: ${db.total_size_gb} GB` : (db.size_mb ? ` | Size: ${(db.size_mb/1024).toFixed(2)} GB` : '');
                const tableInfo = db.table_count ? ` | Tables: ${db.table_count}` : '';
                const connInfo = db.active_connections ? ` | Active Conns: ${db.active_connections}` : '';
                const methodBadge = db.discovery_method === 'direct_connect' ? ' âœ“ Deep' : '';
                wlInventoryRows.push({
                    vm: vmw.vm_name,
                    type: 'Database',
                    typeIcon: 'bi-database',
                    typeColor: '#f59e0b',
                    workload: `${db.engine} (${db.instance_name || 'default'})${methodBadge}`,
                    version: db.version || '?',
                    port: db.port || '',
                    details: `DBs: ${(db.databases || []).join(', ') || 'N/A'}${db.edition ? ' | Ed: '+db.edition : ''}${sizeInfo}${tableInfo}${connInfo}`,
                });
            }
            for (const wa of (vmw.web_apps || [])) {
                wlInventoryRows.push({
                    vm: vmw.vm_name,
                    type: 'Web App',
                    typeIcon: 'bi-globe',
                    typeColor: '#10b981',
                    workload: `${wa.framework || wa.runtime} (${wa.app_name || wa.process_name || ''})`,
                    version: wa.runtime_version || '?',
                    port: wa.port || '',
                    details: `Runtime: ${wa.runtime}${wa.binding ? ' | Bind: '+wa.binding : ''}`,
                });
            }
            for (const cr of (vmw.container_runtimes || [])) {
                wlInventoryRows.push({
                    vm: vmw.vm_name,
                    type: 'Container/Orchestrator',
                    typeIcon: 'bi-box',
                    typeColor: '#06b6d4',
                    workload: `${cr.runtime} (${cr.running_containers}/${cr.total_containers} containers)`,
                    version: cr.version || '?',
                    port: '',
                    details: (cr.containers || []).slice(0,3).map(c => c.name+':'+c.image).join(', ') || 'N/A',
                });
            }
            for (const o of (vmw.orchestrators || [])) {
                wlInventoryRows.push({
                    vm: vmw.vm_name,
                    type: 'Container/Orchestrator',
                    typeIcon: 'bi-diagram-3',
                    typeColor: '#06b6d4',
                    workload: `${o.type} (${o.role})`,
                    version: o.version || '?',
                    port: '',
                    details: `Cluster: ${o.cluster_name || '?'} | Nodes: ${o.node_count} | Pods: ${o.pod_count}`,
                });
            }
        }
        renderWorkloadInventory();

        // Build assessment rows
        wlAssessRows = recs;
        await loadWlWhatIfOverrides();
        await loadWorkloadPerfData();
        renderWorkloadAssessment();

        // Show workload toggle buttons now that discovery is done
        document.getElementById('topo-view-deps').style.display = '';
        document.getElementById('assess-view-wl').style.display = '';
        document.getElementById('sim-view-wl').style.display = '';
    }

    let _wlInventoryTypeFilter = '';  // '' = all, or 'VM','Database','Web App','Container/Orchestrator','Network','File Share'

    function toggleInventoryTypeFilter(type) {
        _wlInventoryTypeFilter = (_wlInventoryTypeFilter === type) ? '' : type;
        // Highlight active card
        document.querySelectorAll('.wl-filter-card').forEach(c => {
            const ct = c.getAttribute('data-type');
            if (_wlInventoryTypeFilter && ct === _wlInventoryTypeFilter) {
                const color = { VM:'#0078d4', Database:'#f59e0b', 'Web App':'#10b981', 'Container/Orchestrator':'#06b6d4', Network:'#e879f9', 'File Share':'#fb923c' }[ct];
                c.style.borderColor = color;
                c.style.boxShadow = `0 0 8px ${color}40`;
            } else {
                c.style.borderColor = 'transparent';
                c.style.boxShadow = 'none';
            }
        });
        renderWorkloadInventory();
    }

    function renderWorkloadInventory() {
        const search = (document.getElementById('wl-inventory-search').value || '').toLowerCase();
        const typeFilter = _wlInventoryTypeFilter;
        const allRows = [...wlInventoryRows, ...infraInventoryRows];
        const filtered = allRows.filter(r => {
            if (typeFilter && r.type !== typeFilter) return false;
            if (search && !(r.vm.toLowerCase().includes(search) || r.workload.toLowerCase().includes(search)
                || r.type.toLowerCase().includes(search) || r.details.toLowerCase().includes(search))) return false;
            return true;
        });
        const tbody = document.getElementById('wl-inventory-tbody');
        tbody.innerHTML = filtered.map(r => {
            const parentCell = (r.type === 'VM' || r.type === 'Network' || r.type === 'File Share')
                ? `<span class="text-muted">${r.vm === 'â€”' ? 'â€”' : r.vm}</span>`
                : '<i class="bi bi-pc-display me-1" style="color:#0078d4"></i>' + r.vm;
            const azureCol = r.azureTarget ? `<span class="small" style="color:#58a6ff">${r.azureTarget}</span>` : '';
            return `<tr>
            <td>${parentCell}</td>
            <td><span style="color:${r.typeColor}"><i class="bi ${r.typeIcon} me-1"></i>${r.type}</span></td>
            <td>${r.workload}</td>
            <td>${r.version}</td>
            <td>${r.port}</td>
            <td class="small text-muted">${r.details}${azureCol ? ' | '+azureCol : ''}</td>
        </tr>`;
        }).join('');
    }

    function filterWorkloadInventory() { renderWorkloadInventory(); }

    let _workloadPerfCache = {};  // { "vm::wl": { cpu, mem_mb, connections } }

    async function loadWorkloadPerfData() {
        try {
            const res = await fetch('/api/perf/workloads');
            const data = await res.json();
            _workloadPerfCache = {};
            data.forEach(w => {
                _workloadPerfCache[w.workload_key] = w;
            });
        } catch(e) { _workloadPerfCache = {}; }
    }

    function renderWorkloadAssessment() {
        const search = (document.getElementById('wl-assess-search').value || '').toLowerCase();
        const filtered = wlAssessRows.filter(r =>
            !search || r.vm_name.toLowerCase().includes(search)
            || r.workload_name.toLowerCase().includes(search)
            || r.recommended_azure_service.toLowerCase().includes(search)
        );
        const tbody = document.getElementById('wl-assess-tbody');
        tbody.innerHTML = filtered.map(r => {
            const approachBadge = r.migration_approach === 'rehost'
                ? '<span class="badge bg-success">Rehost</span>'
                : r.migration_approach === 'replatform'
                ? '<span class="badge bg-warning text-dark">Replatform</span>'
                : '<span class="badge bg-danger">Refactor</span>';
            const complexBadge = r.migration_complexity === 'low'
                ? '<span class="badge bg-success">Low</span>'
                : r.migration_complexity === 'medium'
                ? '<span class="badge bg-warning text-dark">Medium</span>'
                : '<span class="badge bg-danger">High</span>';
            const stepsHtml = (r.migration_steps || []).map((s,i) => `${i+1}. ${s}`).join('<br>');
            const issuesHtml = (r.issues || []).length ? '<span class="text-warning small">' + r.issues.join('; ') + '</span>' : '<span class="text-muted small">None</span>';
            const wlKey = `${r.vm_name}::${r.workload_name}`;
            const hasOverride = wlWhatIfOverridesCache[wlKey];
            const overrideBadge = hasOverride
                ? `<span class="badge badge-ready" style="font-size:0.7rem"><i class="bi bi-check-circle"></i></span>`
                : '';

            // Perf data columns
            const wp = _workloadPerfCache[wlKey] || {};
            const wpCpu = wp.cpu ? wp.cpu.avg.toFixed(1) + '%' : 'â€”';
            const wpMem = wp.mem_mb ? wp.mem_mb.avg.toFixed(0) : 'â€”';
            const wpConn = wp.connections ? wp.connections.avg.toFixed(0) : 'â€”';
            const isInfra = r.workload_type === 'network' || r.workload_type === 'fileshare';

            return `<tr style="cursor:pointer" onclick="openWlWhatIf('${wlKey.replace(/'/g, "\\'")}')">
                <td>${r.vm_name}</td>
                <td>${r.workload_name}</td>
                <td>${r.workload_type}</td>
                <td>${r.source_engine} ${r.source_version}</td>
                <td><strong style="color:var(--azure-light)">${r.recommended_azure_service}</strong>
                    ${(r.alternative_services||[]).length ? '<br><span class="small text-muted">Alt: '+r.alternative_services.join(', ')+'</span>' : ''}
                </td>
                <td>${approachBadge}</td>
                <td>${complexBadge}</td>
                <td>${isInfra ? '<span class="text-muted">â€”</span>' : wpCpu}</td>
                <td>${isInfra ? '<span class="text-muted">â€”</span>' : wpMem}</td>
                <td>${isInfra ? '<span class="text-muted">â€”</span>' : wpConn}</td>
                <td>$${(r.estimated_monthly_cost_usd||0).toFixed(2)}</td>
                <td>${(r.confidence||0).toFixed(0)}%${r.enrichment_boost ? ' <i class="bi bi-arrow-up-circle-fill" style="color:#10b981;font-size:0.65rem" title="Enriched +'+r.enrichment_boost+'% from '+(r.enrichment_tool||'monitoring')+'"></i>' : ''}</td>
                <td>
                    ${overrideBadge}
                    <button class="btn btn-sm btn-outline-secondary" title="What-If Analysis" onclick="event.stopPropagation();openWlWhatIf('${wlKey.replace(/'/g, "\\'")}')"> 
                        <i class="bi bi-sliders"></i>
                    </button>
                </td>
            </tr>`;
        }).join('');
    }

    function filterWorkloadAssessment() { renderWorkloadAssessment(); }

    // --------------- Workload What-If JS ---------------
    async function loadWlWhatIfOverrides() {
        try {
            const res = await fetch('/api/workloads/whatif_overrides');
            wlWhatIfOverridesCache = await res.json();
        } catch(e) { wlWhatIfOverridesCache = {}; }
        // Update override count badge
        const cnt = Object.keys(wlWhatIfOverridesCache).length;
        const badge = document.getElementById('wl-override-count');
        if (badge) {
            badge.textContent = `${cnt} override${cnt!==1?'s':''}`;
            badge.style.display = cnt ? '' : 'none';
        }
    }

    async function openWlWhatIf(workloadKey) {
        const backdrop = document.getElementById('wl-whatif-backdrop');
        backdrop.style.display = 'flex';
        // Reset
        document.getElementById('wl-whatif-title').textContent = workloadKey.replace('::', ' / ');
        document.getElementById('wl-whatif-svc-grid').innerHTML = '<div class="text-muted">Loading...</div>';
        document.getElementById('wl-whatif-details').innerHTML = '';
        wlWhatIfSelectedSvc = null;
        wlWhatIfData = null;

        try {
            const res = await fetch('/api/workloads/whatif', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ workload_key: workloadKey })
            });
            const data = await res.json();
            if (data.error) { alert(data.error); closeWlWhatIf(); return; }
            wlWhatIfData = { ...data, workload_key: workloadKey };

            // Fill details grid
            const rec = data.recommendation;
            document.getElementById('wl-whatif-details').innerHTML = `
                <div><span class="detail-label">VM:</span> ${rec.vm_name}</div>
                <div><span class="detail-label">Workload:</span> ${rec.workload_name}</div>
                <div><span class="detail-label">Type:</span> ${rec.workload_type}</div>
                <div><span class="detail-label">Source:</span> ${rec.source_engine} ${rec.source_version}</div>
                <div><span class="detail-label">Current Service:</span> ${rec.recommended_azure_service}</div>
                <div><span class="detail-label">Current Cost:</span> $${(rec.estimated_monthly_cost_usd||0).toFixed(2)}/mo</div>
            `;

            // Set current cost
            document.getElementById('wl-whatif-current-cost').textContent = `$${(rec.estimated_monthly_cost_usd||0).toFixed(2)}/mo`;
            document.getElementById('wl-whatif-current-svc').textContent = rec.recommended_azure_service;

            // Restore saved override (if any)
            if (data.saved_override) {
                document.getElementById('wl-whatif-region').value = data.saved_override.region || 'eastus';
                document.getElementById('wl-whatif-pricing').value = data.saved_override.pricing || 'pay_as_you_go';
                wlWhatIfSelectedSvc = data.saved_override.service || null;
                showWlSavedBadge(data.saved_override);
            } else {
                document.getElementById('wl-whatif-region').value = 'eastus';
                document.getElementById('wl-whatif-pricing').value = 'pay_as_you_go';
                hideWlSavedBadge();
            }

            // Render service options grid
            renderWlServiceGrid(data.service_options);
            recalcWlWhatIf();
        } catch(e) {
            console.error('Workload what-if error', e);
            document.getElementById('wl-whatif-svc-grid').innerHTML = '<div class="text-danger">Error loading data</div>';
        }
    }

    function closeWlWhatIf() {
        document.getElementById('wl-whatif-backdrop').style.display = 'none';
        if (wlWhatIfChart) { wlWhatIfChart.destroy(); wlWhatIfChart = null; }
    }

    function renderWlServiceGrid(services) {
        const grid = document.getElementById('wl-whatif-svc-grid');
        grid.innerHTML = services.map(svc => {
            const isSelected = svc.name === wlWhatIfSelectedSvc;
            const complexBadge = svc.complexity === 'low'
                ? '<span class="badge bg-success">Low</span>'
                : svc.complexity === 'medium'
                ? '<span class="badge bg-warning text-dark">Medium</span>'
                : '<span class="badge bg-danger">High</span>';
            const approachBadge = svc.migration_approach === 'rehost'
                ? '<span class="badge bg-success">Rehost</span>'
                : svc.migration_approach === 'replatform'
                ? '<span class="badge bg-warning text-dark">Replatform</span>'
                : '<span class="badge bg-danger">Refactor</span>';
            return `
                <div class="sku-option ${isSelected ? 'selected' : ''}"
                     onclick="selectWlService('${svc.name}')">
                    <div class="sku-name">${svc.display}</div>
                    <div class="small text-muted mb-1">${svc.category} â€” ${svc.sku_tier}</div>
                    <div class="mb-1">${approachBadge} ${complexBadge}</div>
                    <div class="sku-cost">$${svc.base_cost.toFixed(2)}/mo</div>
                </div>`;
        }).join('');
    }

    function selectWlService(svcName) {
        wlWhatIfSelectedSvc = svcName;
        if (wlWhatIfData) renderWlServiceGrid(wlWhatIfData.service_options);
        recalcWlWhatIf();
    }

    function recalcWlWhatIf() {
        if (!wlWhatIfData || !wlWhatIfSelectedSvc) {
            document.getElementById('wl-whatif-selected-cost').textContent = 'â€”';
            document.getElementById('wl-whatif-selected-svc').textContent = 'Select a service above';
            document.getElementById('wl-whatif-delta').textContent = 'â€”';
            document.getElementById('wl-whatif-delta-annual').textContent = '';
            return;
        }
        const region = document.getElementById('wl-whatif-region').value;
        const pricing = document.getElementById('wl-whatif-pricing').value;

        const svc = wlWhatIfData.service_options.find(s => s.name === wlWhatIfSelectedSvc);
        if (!svc) return;

        const cost = svc.costs[pricing]?.[region] ?? svc.base_cost;
        const currentCost = wlWhatIfData.recommendation.estimated_monthly_cost_usd || 0;

        document.getElementById('wl-whatif-selected-cost').textContent = `$${cost.toFixed(2)}/mo`;
        document.getElementById('wl-whatif-selected-svc').textContent = svc.display + ' â€¢ ' + region  + ' â€¢ ' + pricing.replace(/_/g, ' ');

        const delta = currentCost - cost;
        const deltaEl = document.getElementById('wl-whatif-delta');
        const deltaAnnualEl = document.getElementById('wl-whatif-delta-annual');
        if (delta > 0) {
            deltaEl.textContent = `-$${delta.toFixed(2)}/mo`;
            deltaEl.style.color = '#3fb950';
            deltaAnnualEl.textContent = `Save $${(delta*12).toFixed(2)}/yr`;
        } else if (delta < 0) {
            deltaEl.textContent = `+$${Math.abs(delta).toFixed(2)}/mo`;
            deltaEl.style.color = '#f85149';
            deltaAnnualEl.textContent = `Extra $${(Math.abs(delta)*12).toFixed(2)}/yr`;
        } else {
            deltaEl.textContent = 'No change';
            deltaEl.style.color = '#8b949e';
            deltaAnnualEl.textContent = '';
        }

        // Update pricing chart
        renderWlPricingChart(svc, region);

        // Show migration steps
        showWlMigrationSteps(svc);
    }

    function renderWlPricingChart(svc, region) {
        const ctx = document.getElementById('chart-wl-whatif-pricing').getContext('2d');
        if (wlWhatIfChart) wlWhatIfChart.destroy();

        const labels = Object.keys(svc.costs).map(k => k.replace(/_/g, ' '));
        const values = Object.keys(svc.costs).map(k => svc.costs[k][region] || svc.base_cost);
        const currentCost = wlWhatIfData.recommendation.estimated_monthly_cost_usd || 0;

        wlWhatIfChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: svc.display,
                        data: values,
                        backgroundColor: '#0078d4cc',
                        borderRadius: 6,
                    },
                    {
                        label: 'Current',
                        data: labels.map(() => currentCost),
                        type: 'line',
                        borderColor: '#f85149',
                        borderDash: [5,5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#c9d1d9' } },
                },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { color: '#8b949e', callback: v => '$'+v }, grid: { color: '#21262d' } },
                },
            }
        });
    }

    function showWlMigrationSteps(svc) {
        const card = document.getElementById('wl-whatif-steps-card');
        const body = document.getElementById('wl-whatif-steps-body');
        // Look up steps from the recommendation's migration_steps if the service matches
        // otherwise show the approach & complexity
        body.innerHTML = `
            <div class="mb-2"><strong>Approach:</strong> ${svc.migration_approach}</div>
            <div class="mb-2"><strong>Complexity:</strong> ${svc.complexity}</div>
            <div><strong>SKU / Tier:</strong> ${svc.sku_tier}</div>
        `;
        card.style.display = '';
    }

    function showWlSavedBadge(override) {
        document.getElementById('wl-whatif-saved-badge').style.display = '';
        document.getElementById('wl-whatif-unsaved-badge').style.display = 'none';
        document.getElementById('wl-whatif-saved-info').textContent =
            `${override.service_display || override.service} â€¢ ${override.region} â€¢ ${override.pricing.replace(/_/g, ' ')} â€¢ $${(override.cost||0).toFixed ? override.cost.toFixed(2) : override.cost}/mo`;
        document.getElementById('wl-whatif-remove-btn').style.display = '';
    }

    function hideWlSavedBadge() {
        document.getElementById('wl-whatif-saved-badge').style.display = 'none';
        document.getElementById('wl-whatif-unsaved-badge').style.display = '';
        document.getElementById('wl-whatif-remove-btn').style.display = 'none';
    }

    async function saveWlWhatIfPreference() {
        if (!wlWhatIfData || !wlWhatIfSelectedSvc) {
            alert('Please select an Azure service first.');
            return;
        }
        const region = document.getElementById('wl-whatif-region').value;
        const pricing = document.getElementById('wl-whatif-pricing').value;
        const svc = wlWhatIfData.service_options.find(s => s.name === wlWhatIfSelectedSvc);
        const cost = svc ? (svc.costs[pricing]?.[region] ?? svc.base_cost) : 0;

        const body = {
            workload_key: wlWhatIfData.workload_key,
            service: wlWhatIfSelectedSvc,
            service_display: svc ? svc.display : wlWhatIfSelectedSvc,
            region, pricing, cost,
        };

        try {
            const res = await fetch('/api/workloads/whatif_overrides', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body),
            });
            const result = await res.json();
            showWlSavedBadge(body);
            // Refresh overrides cache and re-render assessment table
            await loadWlWhatIfOverrides();
            renderWorkloadAssessment();
        } catch(e) { console.error('Save override error', e); }
    }

    async function removeWlWhatIfPreference() {
        if (!wlWhatIfData) return;
        const key = encodeURIComponent(wlWhatIfData.workload_key);
        try {
            await fetch(`/api/workloads/whatif_overrides/${key}`, { method: 'DELETE' });
            hideWlSavedBadge();
            wlWhatIfSelectedSvc = null;
            if (wlWhatIfData) renderWlServiceGrid(wlWhatIfData.service_options);
            recalcWlWhatIf();
            await loadWlWhatIfOverrides();
            renderWorkloadAssessment();
        } catch(e) { console.error('Remove override error', e); }
    }

    async function clearAllWlOverrides() {
        if (!confirm('Remove all workload what-if overrides?')) return;
        try {
            await fetch('/api/workloads/whatif_overrides', { method: 'DELETE' });
            wlWhatIfOverridesCache = {};
            document.getElementById('wl-override-count').style.display = 'none';
            renderWorkloadAssessment();
        } catch(e) { console.error('Clear overrides error', e); }
    }
    // --------------- End Workload What-If JS ---------------

    // --------------- Workload Simulation JS ---------------
    let wlSimData = null;
    let wlSimProjectionChart = null;

    document.getElementById('wlsim-waves').addEventListener('input', function() {
        document.getElementById('wlsim-waves-val').textContent = this.value;
    });

    async function runWlSimulation() {
        const region = document.getElementById('wlsim-region').value;
        const pricing = document.getElementById('wlsim-pricing').value;
        const waves = parseInt(document.getElementById('wlsim-waves').value);
        const filter = document.getElementById('wlsim-filter').value;

        const res = await fetch('/api/workloads/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                target_region: region,
                pricing_model: pricing,
                waves: waves,
                workload_filter: filter,
            })
        });
        const sim = await res.json();
        if (sim.error) { alert(sim.error); return; }
        wlSimData = sim;

        // Show results
        document.getElementById('wlsim-placeholder').style.display = 'none';
        document.getElementById('wlsim-results').style.display = 'block';
        document.getElementById('wlsim-cost-card').style.display = 'block';

        // Cost card
        document.getElementById('wlsim-original-cost').textContent = '$' + sim.total_original_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('wlsim-new-cost').textContent = '$' + sim.total_simulated_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        const savEl = document.getElementById('wlsim-savings-monthly');
        savEl.textContent = '$' + sim.total_savings_monthly.toLocaleString(undefined, {minimumFractionDigits:2});
        savEl.className = 'fw-bold ' + (sim.total_savings_monthly >= 0 ? 'cost-savings' : 'cost-increase');
        document.getElementById('wlsim-savings-annual').textContent = '$' + sim.total_savings_annual.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('wlsim-savings-pct').textContent = sim.savings_percent + '%';

        // Type breakdown cards
        const typeIcons = {database:'bi-database',webapp:'bi-globe',container:'bi-box',orchestrator:'bi-diagram-3'};
        const typeColors = {database:'#f59e0b',webapp:'#10b981',container:'#06b6d4',orchestrator:'#a855f7'};
        const typeCards = document.getElementById('wlsim-type-cards');
        typeCards.innerHTML = Object.entries(sim.type_summary).map(([t, v]) => `
            <div class="col-md-3">
                <div class="stat-card text-center py-2">
                    <i class="bi ${typeIcons[t]||'bi-box'}" style="font-size:1.5rem;color:${typeColors[t]||'#8b949e'}"></i>
                    <div class="stat-label mt-1">${t} (${v.count})</div>
                    <div class="small"><span class="text-muted">$${v.original_cost.toFixed(0)}</span> â†’ <span style="color:#50e6ff">$${v.simulated_cost.toFixed(0)}</span></div>
                    <div class="small" style="color:${v.savings>=0?'#3fb950':'#f85149'}">
                        ${v.savings>=0?'â†“':'â†‘'} $${Math.abs(v.savings).toFixed(0)}/mo
                    </div>
                </div>
            </div>
        `).join('');

        // Projection chart
        renderWlSimCharts();

        // Wave cards â€” draggable
        renderWlWaveCards(sim);

        // Build wave lookup for detail table
        _wlWaveMap = {};
        sim.wave_details.forEach(w => {
            w.workloads.forEach(x => { _wlWaveMap[`${x.vm_name}::${x.workload_name}`] = w.wave; });
        });

        // Detail table
        renderWlSimTable(_wlWaveMap);
    }

    // ================================================================
    // WORKLOAD WAVE DRAG-AND-DROP
    // ================================================================
    let _wlWaveMap = {};

    function renderWlWaveCards(sim) {
        const wavesContainer = document.getElementById('wlsim-waves-container');
        wavesContainer.innerHTML = sim.wave_details.map(w => {
            const dbCount = w.workloads.filter(x => x.workload_type === 'database').length;
            const waCount = w.workloads.filter(x => x.workload_type === 'webapp').length;
            const crCount = w.workloads.filter(x => x.workload_type === 'container').length;
            const orCount = w.workloads.filter(x => x.workload_type === 'orchestrator').length;
            const coCount = crCount + orCount;
            return `<div class="wave-card fade-in" data-wave="${w.wave}"
                         ondragover="wlWaveDragOver(event)" ondragleave="wlWaveDragLeave(event)" ondrop="wlWaveDrop(event, ${w.wave})">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="wave-num">Wave ${w.wave}</span>
                        <span class="badge bg-secondary ms-2">${w.workload_count} workloads</span>
                    </div>
                    <div class="fw-bold" style="color:var(--azure-light)">$${w.cost.toLocaleString(undefined,{minimumFractionDigits:2})}/mo</div>
                </div>
                <div class="d-flex gap-3 mb-2 small text-muted">
                    ${dbCount ? `<span><i class="bi bi-database" style="color:#f59e0b"></i> ${dbCount} DB</span>` : ''}
                    ${waCount ? `<span><i class="bi bi-globe" style="color:#10b981"></i> ${waCount} Web</span>` : ''}
                    ${coCount ? `<span><i class="bi bi-box" style="color:#06b6d4"></i> ${coCount} Cont/Orch</span>` : ''}
                </div>
                <div class="wave-dropzone small text-muted" style="max-height:80px;overflow-y:auto" data-wave="${w.wave}">
                    ${w.workloads.map(x => {
                        const overBadge = x.has_override ? 'âœ“ ' : '';
                        const wlKey = x.vm_name + '::' + x.workload_name;
                        return `<span class="badge bg-dark border border-secondary me-1 mb-1 wave-item"
                            draggable="true" data-wl-key="${wlKey}" data-wave="${w.wave}"
                            ondragstart="wlWaveDragStart(event)" ondragend="wlWaveDragEnd(event)"
                            title="Drag to move to another wave">${overBadge}${x.workload_name.substring(0,25)}</span>`;
                    }).join('')}
                </div>
                <div class="wave-hint"><i class="bi bi-arrows-move me-1"></i>Drag workloads between waves to re-plan</div>
            </div>`;
        }).join('');
    }

    let _wlDragItem = null;
    function wlWaveDragStart(e) {
        _wlDragItem = { key: e.target.dataset.wlKey, fromWave: parseInt(e.target.dataset.wave) };
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.target.dataset.wlKey);
        requestAnimationFrame(() => e.target.classList.add('dragging'));
    }
    function wlWaveDragEnd(e) { e.target.classList.remove('dragging'); }
    function wlWaveDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
    function wlWaveDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
    function wlWaveDrop(e, toWave) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!_wlDragItem) return;
        const { key, fromWave } = _wlDragItem;
        _wlDragItem = null;
        if (fromWave === toWave) return;

        const sim = wlSimData;
        const srcWave = sim.wave_details.find(w => w.wave === fromWave);
        const dstWave = sim.wave_details.find(w => w.wave === toWave);
        if (!srcWave || !dstWave) return;

        const wlIdx = srcWave.workloads.findIndex(x => (x.vm_name + '::' + x.workload_name) === key);
        if (wlIdx === -1) return;

        const [wlObj] = srcWave.workloads.splice(wlIdx, 1);
        dstWave.workloads.push(wlObj);

        // Recalculate wave stats
        sim.wave_details.forEach(w => {
            w.workload_count = w.workloads.length;
            w.cost = Math.round(w.workloads.reduce((s, x) => s + x.simulated_cost, 0) * 100) / 100;
        });

        // Recalculate monthly projection
        let cumulative = 0, wlMigrated = 0;
        sim.monthly_projection = [];
        for (let i = 0; i < 12; i++) {
            if (i < sim.wave_details.length) {
                const waveWls = sim.wave_details[i].workloads;
                wlMigrated += waveWls.length;
                cumulative += waveWls.reduce((s, x) => s + x.simulated_cost, 0);
            }
            sim.monthly_projection.push({
                month: i + 1,
                azure_cost: Math.round(cumulative * 100) / 100,
                workloads_on_azure: wlMigrated,
                workloads_on_prem: sim.total_workloads - wlMigrated,
            });
        }

        // Rebuild wave map
        _wlWaveMap = {};
        sim.wave_details.forEach(w => {
            w.workloads.forEach(x => { _wlWaveMap[`${x.vm_name}::${x.workload_name}`] = w.wave; });
        });

        // Re-render
        renderWlWaveCards(sim);
        renderWlSimTable(_wlWaveMap);
        renderWlSimCharts();
    }

    function renderWlSimCharts() {
        if (!wlSimData) return;
        const sim = wlSimData;
        if (wlSimProjectionChart) wlSimProjectionChart.destroy();
        const proj = sim.monthly_projection;
        const ctx = document.getElementById('chart-wlsim-projection');
        if (!ctx) return;
        wlSimProjectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: proj.map(p => 'Month ' + p.month),
                datasets: [
                    {
                        label: 'Azure Monthly Cost ($)',
                        data: proj.map(p => p.azure_cost),
                        borderColor: '#0078d4',
                        backgroundColor: 'rgba(0,120,212,0.1)',
                        fill: true, tension: 0.3, pointRadius: 4,
                    },
                    {
                        label: 'Workloads on Azure',
                        data: proj.map(p => p.workloads_on_azure),
                        borderColor: '#10b981',
                        borderDash: [5,5], tension: 0.3, pointRadius: 4,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8b949e' } } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { color: '#8b949e', callback: v => '$'+v.toLocaleString() }, grid: { color: '#21262d' }, title: { display: true, text: 'Monthly Cost', color: '#8b949e' } },
                    y1: { position: 'right', ticks: { color: '#10b981' }, grid: { display: false }, title: { display: true, text: 'Workloads Migrated', color: '#10b981' } },
                }
            }
        });
    }

    let _wlSimWaveMap = {};
    function renderWlSimTable(waveMap) {
        if (waveMap) _wlSimWaveMap = waveMap;
        if (!wlSimData) return;
        const search = (document.getElementById('wlsim-search').value || '').toLowerCase();
        let details = wlSimData.workload_details;
        if (search) {
            details = details.filter(d =>
                d.vm_name.toLowerCase().includes(search) ||
                d.workload_name.toLowerCase().includes(search) ||
                d.original_service.toLowerCase().includes(search)
            );
        }
        const tbody = document.getElementById('wlsim-tbody');
        tbody.innerHTML = details.map(d => {
            const savClass = d.savings >= 0 ? 'cost-savings' : 'cost-increase';
            const complexBadge = d.migration_complexity === 'low'
                ? '<span class="badge bg-success">Low</span>'
                : d.migration_complexity === 'medium'
                ? '<span class="badge bg-warning text-dark">Medium</span>'
                : '<span class="badge bg-danger">High</span>';
            const wave = _wlSimWaveMap[`${d.vm_name}::${d.workload_name}`] || '-';
            const overBadge = d.has_override ? '<span class="badge badge-ready ms-1" style="font-size:0.65rem"><i class="bi bi-check-circle"></i></span>' : '';
            return `<tr>
                <td><strong>${d.vm_name.substring(0,18)}</strong><br><span class="small text-muted">${d.workload_name.substring(0,25)}</span></td>
                <td>${d.workload_type}</td>
                <td><code>${d.original_service.substring(0,25)}</code></td>
                <td><code>${d.simulated_service.substring(0,25)}</code>${overBadge}</td>
                <td>$${d.original_cost.toFixed(2)}</td>
                <td>$${d.simulated_cost.toFixed(2)}</td>
                <td class="${savClass}">$${d.savings.toFixed(2)}</td>
                <td>${complexBadge}</td>
                <td><span class="badge bg-secondary">W${wave}</span></td>
            </tr>`;
        }).join('');
    }

    function filterWlSimTable() { renderWlSimTable(); }
    // --------------- End Workload Simulation JS ---------------

    async function loadWorkloadTopology() {
        if (wlTopoNetwork) return;  // already loaded
        try {
            const res = await fetch('/api/workloads/topology');
            const data = await res.json();
            if (!data.nodes.length) return;

            const container = document.getElementById('wl-topology-container');
            wlTopoNetwork = new vis.Network(container, {
                nodes: new vis.DataSet(data.nodes),
                edges: new vis.DataSet(data.edges),
            }, {
                groups: {
                    vm:           { shape:'box',     color:{ background:'#0078d4', border:'#005a9e' }, font:{ color:'#fff', size:13 }, borderWidth:2 },
                    database:     { shape:'diamond', color:{ background:'#f59e0b', border:'#d97706' }, font:{ color:'#fff', size:11 } },
                    webapp:       { shape:'dot',     color:{ background:'#10b981', border:'#059669' }, font:{ color:'#e6edf3', size:11 } },
                    container:    { shape:'triangle',color:{ background:'#06b6d4', border:'#0891b2' }, font:{ color:'#e6edf3', size:11 } },
                    orchestrator: { shape:'star',    color:{ background:'#06b6d4', border:'#0891b2' }, font:{ color:'#e6edf3', size:11 } },
                    network:      { shape:'hexagon',color:{ background:'#e879f9', border:'#d946ef' }, font:{ color:'#fff', size:11 } },
                    fileshare:    { shape:'square', color:{ background:'#fb923c', border:'#ea580c' }, font:{ color:'#fff', size:11 } },
                },
                physics: { stabilization: { iterations: 200 }, barnesHut: { gravitationalConstant: -8000, springLength: 120 } },
                interaction: { hover: true, tooltipDelay: 100 },
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD',
                        sortMethod: 'directed',
                        levelSeparation: 120,
                        nodeSpacing: 160,
                        parentCentralization: true,
                    }
                },
            });
        } catch(e) { console.error('WL topology error', e); }
    }

    function wlTopoFit() { if (wlTopoNetwork) wlTopoNetwork.fit({ animation: true }); }

    // View switch functions for merged panes
    function switchTopoView(view) {
        const isInfra = (view === 'infra');
        document.getElementById('topo-infra-view').style.display = isInfra ? '' : 'none';
        document.getElementById('topo-deps-view').style.display = isInfra ? 'none' : '';
        document.getElementById('topo-view-infra').classList.toggle('active', isInfra);
        document.getElementById('topo-view-deps').classList.toggle('active', !isInfra);
        document.getElementById('topo-physics-btn').style.display = isInfra ? '' : 'none';
        if (!isInfra && wlData && !wlTopoNetwork) loadWorkloadTopology();
    }
    function currentTopoFit() {
        if (document.getElementById('topo-infra-view').style.display !== 'none') { topologyFit(); }
        else { wlTopoFit(); }
    }
    function switchAssessView(view) {
        const isVms = (view === 'vms');
        document.getElementById('assess-vms-view').style.display = isVms ? '' : 'none';
        document.getElementById('assess-wl-view').style.display = isVms ? 'none' : '';
        document.getElementById('assess-view-vms').classList.toggle('active', isVms);
        document.getElementById('assess-view-wl').classList.toggle('active', !isVms);
    }
    function switchSimView(view) {
        const isVms = (view === 'vms');
        document.getElementById('sim-vms-view').style.display = isVms ? '' : 'none';
        document.getElementById('sim-wl-view').style.display = isVms ? 'none' : '';
        document.getElementById('sim-view-vms').classList.toggle('active', isVms);
        document.getElementById('sim-view-wl').classList.toggle('active', !isVms);
        if (!isVms) setTimeout(renderWlSimCharts, 200);
    }

    // ================================================================
    // CONNECTION FLOW
    // ================================================================

    function startDiscovery(e) {
        e.preventDefault();
        const url  = document.getElementById('vcUrl').value.trim();
        const user = document.getElementById('vcUser').value.trim();
        const pass = document.getElementById('vcPass').value;
        const port = parseInt(document.getElementById('vcPort').value) || 443;
        const ssl  = document.getElementById('vcSsl').checked;
        const perf = document.getElementById('vcPerf').checked;
        const perfDays = parseInt(document.getElementById('vcPerfDuration').value) || 7;

        hideConnectError();
        document.getElementById('btnConnect').disabled = true;
        document.getElementById('btnConnect').innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Connectingâ€¦';
        showProgress('Connecting to vCenterâ€¦', 5);

        fetch('/api/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                vcenter_url: url, username: user, password: pass,
                port: port, disable_ssl: ssl, collect_perf: perf,
                perf_duration_days: perfDays
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showConnectError(data.error);
                resetConnectBtn();
            } else {
                pollDiscovery();
            }
        })
        .catch(err => {
            showConnectError('Connection failed: ' + err.message);
            resetConnectBtn();
        });
        return false;
    }

    function showProgress(msg, pct) {
        document.getElementById('progressArea').classList.add('active');
        document.getElementById('connectForm').style.display = 'none';
        document.getElementById('connectDivider').style.display = 'none';
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('progressFill').style.width = (pct || 0) + '%';
        document.getElementById('progressMsg').textContent = msg || 'Workingâ€¦';
    }

    function pollDiscovery() {
        const poll = setInterval(async () => {
            try {
                const res = await fetch('/api/discover/status');
                const st = await res.json();
                document.getElementById('progressFill').style.width = st.progress + '%';
                document.getElementById('progressMsg').textContent = st.message || 'Workingâ€¦';

                if (st.status === 'complete') {
                    clearInterval(poll);
                    document.getElementById('progressMsg').textContent = 'âœ“ ' + st.message;
                    setTimeout(() => { hideConnect(); initDashboard(); }, 1000);
                } else if (st.status === 'error') {
                    clearInterval(poll);
                    showConnectError(st.message);
                    resetConnectForm();
                }
            } catch(e) { console.error('Poll error', e); }
        }, 2000);
    }

    function uploadReport(input) {
        if (!input.files.length) return;
        const formData = new FormData();
        formData.append('file', input.files[0]);

        showProgress('Loading report fileâ€¦', 50);

        fetch('/api/upload', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showConnectError(data.error);
                resetConnectForm();
            } else {
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressMsg').textContent =
                    'âœ“ Loaded ' + data.vms + ' VMs from file';
                setTimeout(() => { hideConnect(); initDashboard(); }, 800);
            }
        })
        .catch(err => {
            showConnectError('Upload failed: ' + err.message);
            resetConnectForm();
        });
    }

    async function hideConnect() {
        document.getElementById('connectOverlay').classList.add('hidden');
        document.getElementById('btnDisconnect').classList.remove('d-none');
        try {
            const res = await fetch('/api/status');
            const s = await res.json();
            if (s.vcenter_host) {
                document.getElementById('navHostName').textContent = s.vcenter_host;
                document.getElementById('navHost').classList.remove('d-none');
            }
        } catch(e) {}
    }

    async function disconnect() {
        await fetch('/api/disconnect', { method: 'POST' });
        document.getElementById('connectOverlay').classList.remove('hidden');
        document.getElementById('btnDisconnect').classList.add('d-none');
        document.getElementById('navHost').classList.add('d-none');
        resetConnectForm();
        document.getElementById('progressArea').classList.remove('active');
        hideConnectError();
        summaryData = null;
        allVMs = [];
        document.getElementById('vm-summary-card').style.display = 'none';
        document.getElementById('wl-summary-section').style.display = 'none';
    }

    function showConnectError(msg) {
        const el = document.getElementById('connectError');
        el.textContent = 'âš  ' + msg;
        el.style.display = 'block';
        document.getElementById('progressArea').classList.remove('active');
    }

    function hideConnectError() {
        document.getElementById('connectError').style.display = 'none';
    }

    function resetConnectForm() {
        document.getElementById('connectForm').style.display = 'block';
        document.getElementById('connectDivider').style.display = 'flex';
        document.getElementById('uploadArea').style.display = 'block';
        resetConnectBtn();
    }

    function resetConnectBtn() {
        const btn = document.getElementById('btnConnect');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plug me-2"></i>Connect &amp; Discover';
    }

    /** Load all dashboard tabs after data becomes available. */
    function initDashboard() {
        loadDashboard();
        setTimeout(loadAssessment, 500);
    }

    // ================================================================
    // INIT â€” check if data already loaded (e.g. page refresh)
    // ================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('/api/status');
            const s = await res.json();
            if (s.data_loaded) {
                hideConnect();
                initDashboard();
            } else {
                const ds = s.discovery_state;
                if (['connecting','discovering','mapping','building'].includes(ds.status)) {
                    showProgress(ds.message, ds.progress);
                    pollDiscovery();
                }
                // else: stay on connection screen
            }

            // Auto-load workload data from data/ folder if available
            try {
                const wlRes = await fetch('/api/workloads/results');
                if (wlRes.ok) {
                    const wlTest = await wlRes.json();
                    if (wlTest && wlTest.recommendations && !wlTest.error) {
                        // Trigger the same flow as post-discovery
                        await loadWorkloadResults();
                    }
                }
            } catch(e) { /* no workload data */ }
        } catch(e) {
            console.error('Init status check failed', e);
        }
    });

    // ================================================================
    // BUSINESS CASE
    // ================================================================
    let bcTcoChart, bcCumulativeChart, bcOnpremChart, bcAzureChart, bcYoyChart;

    async function loadBusinessCase() {
        const pricing = document.getElementById('bc-pricing').value;
        const region = document.getElementById('bc-region').value;
        const years = document.getElementById('bc-years').value;

        document.getElementById('bc-empty').classList.add('d-none');
        document.getElementById('bc-results').classList.add('d-none');
        document.getElementById('bc-loading').classList.remove('d-none');

        try {
            const res = await fetch(`/api/businesscase?pricing_model=${pricing}&target_region=${region}&analysis_years=${years}`);
            if (!res.ok) { throw new Error('Failed to generate business case'); }
            const bc = await res.json();

            document.getElementById('bc-loading').classList.add('d-none');
            document.getElementById('bc-results').classList.remove('d-none');
            document.getElementById('bc-export-btn').disabled = false;

            renderBusinessCase(bc);
        } catch (e) {
            document.getElementById('bc-loading').classList.add('d-none');
            document.getElementById('bc-empty').classList.remove('d-none');
            console.error('Business case error:', e);
        }
    }

    function renderBusinessCase(bc) {
        const fmt = v => '$' + v.toLocaleString(undefined, {maximumFractionDigits:0});
        const es = bc.executive_summary;

        // Executive banner
        document.getElementById('bc-subtitle').textContent =
            `${es.total_vms} VMs | ${es.total_hosts} Hosts | ${bc.analysis_years}-Year Analysis | ${bc.pricing_model.replace(/_/g,' ')} | ${bc.target_region}`;
        document.getElementById('bc-annual-savings').textContent = fmt(bc.annual_savings);
        document.getElementById('bc-savings-pct').textContent = bc.savings_pct + '%';
        document.getElementById('bc-payback').textContent = bc.payback_months > 0 ? bc.payback_months + ' mo' : 'N/A';
        document.getElementById('bc-years-label').textContent = bc.analysis_years;
        document.getElementById('bc-tco-savings').textContent = fmt(bc.total_tco_savings);

        // Fleet cards
        document.getElementById('bc-total-vms').textContent = es.total_vms;
        document.getElementById('bc-total-hosts').textContent = es.total_hosts;
        document.getElementById('bc-total-vcpus').textContent = es.total_vcpus;
        document.getElementById('bc-total-mem').textContent = es.total_memory_gb.toLocaleString(undefined,{maximumFractionDigits:0});
        document.getElementById('bc-total-storage').textContent = es.total_storage_tb.toFixed(1);
        document.getElementById('bc-readiness').textContent = es.readiness_pct + '%';

        // Monthly banners
        document.getElementById('bc-onprem-monthly').textContent = fmt(bc.onprem_monthly);
        document.getElementById('bc-azure-monthly').textContent = fmt(bc.azure_monthly);

        // Destroy old charts
        [bcTcoChart, bcCumulativeChart, bcOnpremChart, bcAzureChart, bcYoyChart].forEach(c => c && c.destroy());

        // TCO comparison bar chart
        bcTcoChart = new Chart(document.getElementById('chart-bc-tco'), {
            type: 'bar',
            data: {
                labels: ['On-Premises', 'Azure', 'Net Savings'],
                datasets: [{
                    data: [bc.total_tco_onprem, bc.total_tco_azure, bc.total_tco_savings],
                    backgroundColor: ['#e74c3c', '#3498db', '#2ecc71'],
                    borderWidth: 0,
                    borderRadius: 6,
                    barThickness: 60
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => fmt(ctx.raw) } }
                },
                scales: {
                    y: { ticks: { color:'#8b949e', callback: v => '$'+v.toLocaleString() }, grid:{ color:'rgba(255,255,255,0.06)' } },
                    x: { ticks: { color:'#8b949e' }, grid:{ display:false } }
                }
            }
        });

        // Cumulative savings line chart
        const proj = bc.yearly_projection;
        bcCumulativeChart = new Chart(document.getElementById('chart-bc-cumulative'), {
            type: 'line',
            data: {
                labels: proj.map(p => 'Year ' + p.year),
                datasets: [
                    {
                        label: 'Cumulative Savings',
                        data: proj.map(p => p.cumulative_savings),
                        borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.1)',
                        fill: true, tension: 0.3, pointRadius: 5, pointBackgroundColor: '#2ecc71'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => fmt(ctx.raw) } },
                    annotation: {
                        annotations: {
                            breakeven: {
                                type: 'line', yMin: 0, yMax: 0,
                                borderColor: 'rgba(255,255,255,0.3)', borderDash: [5,5], borderWidth: 1,
                                label: { display: true, content: 'Break Even', position: 'start', color: '#8b949e', font:{size:10} }
                            }
                        }
                    }
                },
                scales: {
                    y: { ticks: { color:'#8b949e', callback: v => '$'+v.toLocaleString() }, grid:{ color:'rgba(255,255,255,0.06)' } },
                    x: { ticks: { color:'#8b949e' }, grid:{ display:false } }
                }
            }
        });

        // On-prem doughnut
        const ob = bc.onprem_breakdown;
        const onpremLabels = Object.keys(ob).map(k => k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()));
        const onpremColors = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#34495e','#e84393','#fd79a8','#636e72'];
        bcOnpremChart = new Chart(document.getElementById('chart-bc-onprem'), {
            type: 'doughnut',
            data: {
                labels: onpremLabels,
                datasets: [{ data: Object.values(ob), backgroundColor: onpremColors.slice(0,onpremLabels.length), borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '55%',
                plugins: {
                    legend: { position:'bottom', labels: { color:'#8b949e', boxWidth:10, font:{size:10} } },
                    tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmt(ctx.raw) } }
                }
            }
        });

        // Azure doughnut
        const ab = bc.azure_breakdown;
        const azureLabels = Object.keys(ab).map(k => k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()));
        const azureColors = ['#3498db','#2980b9','#1abc9c','#16a085','#2ecc71','#27ae60','#8e44ad'];
        bcAzureChart = new Chart(document.getElementById('chart-bc-azure'), {
            type: 'doughnut',
            data: {
                labels: azureLabels,
                datasets: [{ data: Object.values(ab), backgroundColor: azureColors.slice(0,azureLabels.length), borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '55%',
                plugins: {
                    legend: { position:'bottom', labels: { color:'#8b949e', boxWidth:10, font:{size:10} } },
                    tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmt(ctx.raw) } }
                }
            }
        });

        // Year-over-year bar chart
        bcYoyChart = new Chart(document.getElementById('chart-bc-yoy'), {
            type: 'bar',
            data: {
                labels: proj.map(p => 'Year ' + p.year),
                datasets: [
                    { label: 'On-Premises', data: proj.map(p=>p.onprem_cost), backgroundColor:'#e74c3c', borderRadius:4, barPercentage:0.7 },
                    { label: 'Azure', data: proj.map(p=>p.azure_cost), backgroundColor:'#3498db', borderRadius:4, barPercentage:0.7 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position:'bottom', labels:{color:'#8b949e'} },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) } }
                },
                scales: {
                    y: { ticks:{color:'#8b949e', callback:v=>'$'+v.toLocaleString()}, grid:{color:'rgba(255,255,255,0.06)'} },
                    x: { ticks:{color:'#8b949e'}, grid:{display:false} }
                }
            }
        });

        // Key benefits
        const benefitsHtml = bc.key_benefits.map(b => `
            <div class="col-md-4">
                <div class="p-3 rounded h-100" style="background:rgba(255,255,255,0.04);border:1px solid var(--border)">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-${b.icon} me-2" style="font-size:1.3rem;color:#5dade2"></i>
                        <strong>${b.title}</strong>
                    </div>
                    <small class="text-muted">${b.description}</small>
                </div>
            </div>
        `).join('');
        document.getElementById('bc-benefits-grid').innerHTML = benefitsHtml;

        // Migration investment table
        const mb = bc.migration_breakdown;
        let migHtml = '';
        for (const [k,v] of Object.entries(mb)) {
            migHtml += `<tr><td>${k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</td><td class="text-end">${fmt(v)}</td></tr>`;
        }
        document.getElementById('bc-migration-table').innerHTML = migHtml;
        document.getElementById('bc-migration-total').textContent = fmt(bc.migration_one_time);

        // Risks
        const severityColors = { high:'#e74c3c', medium:'#f39c12', low:'#3498db' };
        const severityIcons = { high:'exclamation-triangle-fill', medium:'exclamation-circle', low:'info-circle' };
        const risksHtml = bc.risks.map(r => `
            <div class="d-flex align-items-start mb-2 p-2 rounded" style="background:rgba(255,255,255,0.04)">
                <i class="bi bi-${severityIcons[r.severity]} me-2 mt-1" style="color:${severityColors[r.severity]}"></i>
                <div>
                    <strong>${r.area}</strong>
                    <span class="badge ms-1" style="background:${severityColors[r.severity]};font-size:0.65rem">${r.severity.toUpperCase()}</span>
                    <div class="text-muted small">${r.description}</div>
                </div>
            </div>
        `).join('');
        document.getElementById('bc-risks-list').innerHTML = risksHtml;

        // Assumptions
        const a = bc.assumptions;
        const assumptionItems = Object.entries(a).map(([k,v]) => {
            const label = k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            const val = typeof v === 'number' ? (v >= 100 ? fmt(v) : v) : v;
            return `<div class="col-md-4 col-lg-3 mb-1"><small class="text-muted">${label}:</small> <small class="fw-bold">${val}</small></div>`;
        }).join('');
        document.getElementById('bc-assumptions-content').innerHTML = assumptionItems;
    }

    function exportBusinessCasePDF() {
        // Print-friendly export â€” open in new window for browser print-to-PDF
        const content = document.getElementById('bc-results').innerHTML;
        const win = window.open('', '_blank');
        win.document.write(`<!DOCTYPE html><html><head><title>Azure Migration Business Case</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
            <style>body{background:#fff;color:#222;padding:20px;font-size:12px}
            .stat-card{padding:12px;border:1px solid #ddd;border-radius:8px}
            .stat-value{font-size:1.3rem;font-weight:700}.stat-label{font-size:0.75rem;color:#666}
            .card{border:1px solid #ddd!important;background:#fff!important}
            .card-title{color:#222!important}.text-muted{color:#666!important}
            canvas{max-height:200px}
            @media print{.no-print{display:none}}</style></head>
            <body><h2 class="mb-4">Azure Migration Business Case</h2>${content}
            <script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
        win.document.close();
    }

    // =======================================================================
    // ENRICHMENT DATA LOOP
    // =======================================================================

    let _enrConfidenceChart = null;
    let _enrMetricsChart = null;

    // Load enrichment tab when clicked
    document.getElementById('tab-enrichment')?.addEventListener('shown.bs.tab', loadEnrichmentTab);

    function loadEnrichmentTab() {
        loadEnrichmentTools();
        loadEnrichmentStatus();
        loadEnrichmentData();
        loadEnrichmentHistory();
    }

    function loadEnrichmentTools() {
        fetch('/api/enrichment/tools')
            .then(r => r.json())
            .then(tools => {
                // Populate dropdown
                const sel = document.getElementById('enr-tool-select');
                sel.innerHTML = '<option value="">-- Select tool --</option>';
                tools.forEach(t => {
                    sel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });

                // Populate grid
                const grid = document.getElementById('enr-tools-grid');
                grid.innerHTML = tools.map(t => `
                    <div class="col-6 col-md-3 col-lg-2">
                        <div class="stat-card text-center p-3" style="border-left:3px solid ${t.color}">
                            <i class="bi ${t.icon}" style="font-size:1.5rem;color:${t.color}"></i>
                            <div class="mt-1 small fw-bold">${t.name}</div>
                            <div class="text-muted" style="font-size:0.7rem">JSON export</div>
                        </div>
                    </div>
                `).join('');
            });
    }

    function loadEnrichmentStatus() {
        fetch('/api/enrichment/status')
            .then(r => r.json())
            .then(s => {
                document.getElementById('enr-total-vms').textContent = s.total_vms;
                document.getElementById('enr-enriched-vms').textContent = s.enriched_vms;
                document.getElementById('enr-coverage').textContent = s.coverage_pct + '%';
                document.getElementById('enr-avg-boost').textContent = '+' + s.avg_confidence_boost + '%';
                document.getElementById('enr-tools-used').textContent = s.tools_used.length;
                document.getElementById('enr-ingestions').textContent = s.total_ingestions;
            });
    }

    function loadEnrichmentData() {
        fetch('/api/enrichment/data')
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById('enr-data-tbody');
                const emptyMsg = document.getElementById('enr-empty-msg');
                const entries = Object.entries(d.telemetry || {});

                if (entries.length === 0) {
                    tbody.innerHTML = '';
                    emptyMsg.style.display = '';
                    return;
                }
                emptyMsg.style.display = 'none';

                tbody.innerHTML = entries.map(([name, e]) => {
                    const m = e.metrics || {};
                    const boost = e.confidence_boost || 0;
                    const boostColor = boost >= 20 ? '#10b981' : boost >= 10 ? '#f59e0b' : '#6c757d';
                    const deps = (e.dependencies||[]).length;
                    return `<tr>
                        <td><strong>${name}</strong></td>
                        <td><span class="badge" style="background:#30363d">${e.monitoring_tool||'â€”'}</span></td>
                        <td>${m.avg_cpu_pct != null ? m.avg_cpu_pct.toFixed(1)+'%' : 'â€”'}</td>
                        <td>${m.p95_cpu_pct != null ? m.p95_cpu_pct.toFixed(1)+'%' : 'â€”'}</td>
                        <td>${m.avg_memory_pct != null ? m.avg_memory_pct.toFixed(1)+'%' : 'â€”'}</td>
                        <td>${m.p95_memory_pct != null ? m.p95_memory_pct.toFixed(1)+'%' : 'â€”'}</td>
                        <td>${m.avg_disk_iops != null ? m.avg_disk_iops.toFixed(0) : 'â€”'}</td>
                        <td>${m.avg_network_kbps != null ? m.avg_network_kbps.toFixed(0) : 'â€”'}</td>
                        <td>${m.avg_response_time_ms != null ? m.avg_response_time_ms.toFixed(1)+'ms' : 'â€”'}</td>
                        <td>${m.error_rate_pct != null ? m.error_rate_pct.toFixed(2)+'%' : 'â€”'}</td>
                        <td>${deps > 0 ? deps : 'â€”'}</td>
                        <td>${e.collection_period_days}d</td>
                        <td>${e.sample_count||'â€”'}</td>
                        <td><strong style="color:${boostColor}">+${boost}%</strong></td>
                    </tr>`;
                }).join('');

                // Render charts
                renderEnrichmentCharts(entries);
            });
    }

    function renderEnrichmentCharts(entries) {
        // Confidence distribution chart â€” buckets before and after
        const baseScores = [];
        const enrichedScores = [];

        // Fetch VM data to get base confidence vs enriched
        fetch('/api/vms')
            .then(r => r.json())
            .then(vms => {
                vms.forEach(vm => {
                    const r = vm.recommendation || {};
                    const base = (r.confidence_score || 50) - (r.enrichment_boost || 0);
                    const enriched = r.confidence_score || 50;
                    baseScores.push(base);
                    enrichedScores.push(enriched);
                });

                // Build histogram buckets
                const buckets = ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'];
                function toBuckets(scores) {
                    const b = [0,0,0,0,0];
                    scores.forEach(s => {
                        if (s < 20) b[0]++;
                        else if (s < 40) b[1]++;
                        else if (s < 60) b[2]++;
                        else if (s < 80) b[3]++;
                        else b[4]++;
                    });
                    return b;
                }

                const ctx1 = document.getElementById('enr-confidence-chart');
                if (_enrConfidenceChart) _enrConfidenceChart.destroy();
                _enrConfidenceChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: buckets,
                        datasets: [
                            {label: 'Before Enrichment', data: toBuckets(baseScores), backgroundColor: 'rgba(239,68,68,0.6)', borderRadius: 4},
                            {label: 'After Enrichment', data: toBuckets(enrichedScores), backgroundColor: 'rgba(16,185,129,0.6)', borderRadius: 4},
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {legend: {labels: {color: '#aaa'}}, title: {display: false}},
                        scales: {
                            x: {ticks: {color: '#aaa'}, grid: {color: 'rgba(255,255,255,0.05)'}},
                            y: {ticks: {color: '#aaa'}, grid: {color: 'rgba(255,255,255,0.05)'},
                                title: {display: true, text: 'VM Count', color: '#aaa'}}
                        }
                    }
                });
            });

        // Metrics coverage radar
        const metricLabels = ['CPU Avg', 'CPU P95', 'Memory Avg', 'Memory P95', 'Disk IOPS', 'Network', 'Response Time', 'Error Rate'];
        const metricKeys = ['avg_cpu_pct', 'p95_cpu_pct', 'avg_memory_pct', 'p95_memory_pct', 'avg_disk_iops', 'avg_network_kbps', 'avg_response_time_ms', 'error_rate_pct'];
        const coverage = metricKeys.map(k => {
            const count = entries.filter(([_, e]) => (e.metrics||{})[k] != null).length;
            return entries.length > 0 ? Math.round(count / entries.length * 100) : 0;
        });

        const ctx2 = document.getElementById('enr-metrics-chart');
        if (_enrMetricsChart) _enrMetricsChart.destroy();
        _enrMetricsChart = new Chart(ctx2, {
            type: 'radar',
            data: {
                labels: metricLabels,
                datasets: [{
                    label: 'Coverage %',
                    data: coverage,
                    backgroundColor: 'rgba(0,120,212,0.2)',
                    borderColor: '#0078d4',
                    pointBackgroundColor: '#0078d4',
                }]
            },
            options: {
                responsive: true,
                plugins: {legend: {labels: {color: '#aaa'}}},
                scales: {
                    r: {
                        suggestedMin: 0, suggestedMax: 100,
                        ticks: {color: '#aaa', backdropColor: 'transparent'},
                        grid: {color: 'rgba(255,255,255,0.1)'},
                        pointLabels: {color: '#aaa', font: {size: 10}},
                    }
                }
            }
        });
    }

    function loadEnrichmentHistory() {
        fetch('/api/enrichment/history')
            .then(r => r.json())
            .then(d => {
                const tbody = document.getElementById('enr-history-tbody');
                if (!d.history || d.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No ingestion history yet</td></tr>';
                    return;
                }
                tbody.innerHTML = d.history.slice().reverse().map(h => `<tr>
                    <td>${new Date(h.ingested_at).toLocaleString()}</td>
                    <td><span class="badge" style="background:#30363d">${h.tool}</span></td>
                    <td><span style="color:#10b981">${h.entities_matched}</span></td>
                    <td><span style="color:#f59e0b">${h.entities_unmatched}</span></td>
                    <td>${h.total_records}</td>
                </tr>`).join('');
            });
    }

    function uploadEnrichmentData() {
        const tool = document.getElementById('enr-tool-select').value;
        const fileInput = document.getElementById('enr-file-input');
        const resultDiv = document.getElementById('enr-upload-result');

        if (!tool) {
            resultDiv.style.display = '';
            resultDiv.innerHTML = '<div class="alert alert-warning py-2 small"><i class="bi bi-exclamation-triangle me-1"></i> Please select a monitoring tool.</div>';
            return;
        }
        if (!fileInput.files || !fileInput.files[0]) {
            resultDiv.style.display = '';
            resultDiv.innerHTML = '<div class="alert alert-warning py-2 small"><i class="bi bi-exclamation-triangle me-1"></i> Please select a JSON file to upload.</div>';
            return;
        }

        const formData = new FormData();
        formData.append('tool', tool);
        formData.append('file', fileInput.files[0]);

        resultDiv.style.display = '';
        resultDiv.innerHTML = '<div class="alert alert-info py-2 small"><i class="bi bi-hourglass-split me-1"></i> Uploading and processing...</div>';

        fetch('/api/enrichment/upload', {method: 'POST', body: formData})
            .then(r => r.json())
            .then(res => {
                if (res.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger py-2 small"><i class="bi bi-x-circle me-1"></i> ${res.error}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-success py-2 small">
                        <i class="bi bi-check-circle me-1"></i> <strong>Success!</strong> ${res.message}
                        <br><small>Matched: ${res.entities_matched} | Unmatched: ${res.entities_unmatched} | Total: ${res.total_records}</small>
                    </div>`;
                    fileInput.value = '';
                    loadEnrichmentTab();
                }
            })
            .catch(err => {
                resultDiv.innerHTML = `<div class="alert alert-danger py-2 small"><i class="bi bi-x-circle me-1"></i> Upload failed: ${err.message}</div>`;
            });
    }

    function generateSampleEnrichment() {
        const tool = document.getElementById('enr-tool-select').value || 'dynatrace';
        const resultDiv = document.getElementById('enr-upload-result');
        resultDiv.style.display = '';
        resultDiv.innerHTML = '<div class="alert alert-info py-2 small"><i class="bi bi-hourglass-split me-1"></i> Generating sample data...</div>';

        fetch('/api/enrichment/generate_sample', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tool: tool})
        })
        .then(r => r.json())
        .then(res => {
            if (res.error) {
                resultDiv.innerHTML = `<div class="alert alert-danger py-2 small"><i class="bi bi-x-circle me-1"></i> ${res.error}</div>`;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-success py-2 small">
                    <i class="bi bi-check-circle me-1"></i> <strong>Sample generated!</strong> ${res.message}
                </div>`;
                loadEnrichmentTab();
            }
        });
    }

    function clearEnrichmentData() {
        if (!confirm('Clear all enrichment data? This will reset confidence boosts.')) return;
        fetch('/api/enrichment/clear', {method: 'POST'})
            .then(r => r.json())
            .then(() => {
                document.getElementById('enr-upload-result').style.display = 'none';
                loadEnrichmentTab();
            });
    }

    </script>
</body>
</html>
